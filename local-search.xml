<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>AIç¼–è¯‘å™¨ç›¸å…³å­¦ä¹ </title>
    <link href="/2023/10/16/AI%E7%BC%96%E8%AF%91%E5%99%A8%E7%9B%B8%E5%85%B3%E5%AD%A6%E4%B9%A0/"/>
    <url>/2023/10/16/AI%E7%BC%96%E8%AF%91%E5%99%A8%E7%9B%B8%E5%85%B3%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>å‚è€ƒï¼š<br><a href="https://github.com/BBuf/tvm_mlir_learn">https://github.com/BBuf/tvm_mlir_learn</a><br><a href="https://space.bilibili.com/517221395/channel/collectiondetail?sid=857162">https://space.bilibili.com/517221395/channel/collectiondetail?sid=857162</a></p><span id="more"></span><h2 id="1-ç¼–è¯‘å™¨ç›¸å…³">1. ç¼–è¯‘å™¨ç›¸å…³</h2><p>ç¼–è¯‘å™¨ï¼ˆCompilerï¼‰å’Œè§£é‡Šå™¨ï¼ˆInterpreterï¼‰ï¼š</p><ul><li>ç¼–è¯‘å™¨ï¼šå°†æºä»£ç æ•´ä½“ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæœºå™¨ç ï¼‰ï¼Œï¼ˆå¯èƒ½ç»è¿‡é¢„ç¼–è¯‘ã€ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥ç­‰ç¯èŠ‚ï¼Œç»Ÿä¸€è§†ä½œç¼–è¯‘å™¨çš„æµç¨‹ï¼‰æœ€åç”±æœºå™¨æ‰§è¡Œï¼Œä¼šäº§ç”Ÿå¯ä»¥é‡å¤ä½¿ç”¨çš„ä¸­é—´æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶</li><li>è§£é‡Šå™¨ï¼šå°†æºä»£ç é€è¡Œè§£é‡Šæˆå­—èŠ‚ç å¹¶ç›´æ¥äº¤ç”±æœºå™¨æ‰§è¡Œï¼Œä¸äº§ç”Ÿå…¶ä»–æ–‡ä»¶</li></ul><p>ç¼–è¯‘å™¨ç¼–è¯‘æ–¹å¼ï¼šJITå’ŒAOT</p><ul><li>AOTï¼šAheadOfTimeå³é™æ€ç¼–è¯‘ï¼Œæºä»£ç å…ˆç»Ÿä¸€ç¼–è¯‘æˆæœºå™¨ç ï¼Œå†æ‰§è¡Œ</li><li>JITï¼šJustInTimeå³åŠ¨æ€ç¼–è¯‘ï¼Œç›¸æ¯”äºä¼ ç»ŸAOTï¼ŒJITå¯ä»¥åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å˜è¿è¡Œè¾¹ç¼–è¯‘ï¼Œå…·ä½“æµç¨‹å¯ä»¥å‚è€ƒjavaã€‚æ³¨æ„JITä¸è§£é‡Šå™¨çš„åŒºåˆ«ï¼Œè§£é‡Šå™¨çš„ç²’åº¦ä¸ºä¸€è¡Œæºä»£ç ï¼Œè€ŒJITçš„ç²’åº¦ä¸ºä¸€ä¸ªå‡½æ•°ï¼ŒJITç¼–è¯‘çš„å‡½æ•°å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œè€Œè§£é‡Šå™¨æ¯æ¬¡éƒ½è¦é‡æ–°è§£é‡Šä¸€éã€‚</li></ul><p>ä¸€ä¸ªGCCçš„æ ‡å‡†ç¼–è¯‘æµç¨‹ï¼š</p><ol><li>é¢„å¤„ç†ï¼šå¤„ç†å®å®šä¹‰ã€æ–‡ä»¶åŒ…å«ã€æ¡ä»¶ç¼–è¯‘ç­‰ä¿¡æ¯ï¼Œç”Ÿæˆ .i æ–‡ä»¶</li><li>ç¼–è¯‘ï¼šå¯¹ .i æ–‡ä»¶è¿›è¡Œè¯­æ³•åˆ†æï¼Œä¼˜åŒ–åç”Ÿæˆ .s æ±‡ç¼–æ–‡ä»¶</li><li>æ±‡ç¼–ï¼šå°† .s æ±‡ç¼–æ–‡ä»¶æ±‡ç¼–ä¸ºæœºå™¨ç  .o æ–‡ä»¶</li><li>é“¾æ¥ï¼šå°†ç¨‹åºè¿è¡Œæ‰€éœ€è¦çš„ç›®æ ‡æ–‡ä»¶ã€ä¾èµ–åº“æ–‡ä»¶ç­‰ç»Ÿä¸€æ‰“åŒ…é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶</li></ol><p>LLVMåœ¨GCCçš„åŸºç¡€ä¸Šå‘å±•è€Œæ¥ï¼Œæ—©æœŸè‹¹æœä½¿ç”¨GCCç¼–ï¼Œåæ¥ç”±äºGCCè¯ä¹¦ä»¥åŠè‹¹æœçš„å•†ç”¨éœ€è¦ï¼Œåªèƒ½æ”¾å¼ƒGCCè€Œå•ç‹¬å‘å±•å‡ºLLVMï¼ŒLLVMæœ¬è´¨ç®—ä¸€ä¸ªç¼–è¯‘å™¨çš„æ¡†æ¶ç³»ç»Ÿï¼Œä½¿ç”¨æ¨¡å—åŒ–çš„æ–¹å¼ï¼Œå°†ç¼–è¯‘å™¨çš„å‰ç«¯ã€ä¼˜åŒ–å™¨ã€åç«¯ç­‰æ¨¡å—åˆ†å¼€ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œç»„åˆï¼Œæ¯”å¦‚ç›®å‰ä¸»æµçš„Clangå°±æ˜¯LLVMçš„å‰ç«¯ï¼Œè€ŒLLVMçš„åç«¯å¯ä»¥ç”Ÿæˆå¤šç§å¹³å°çš„æœºå™¨ç ï¼ŒLLVMçš„ä¼˜åŒ–å™¨ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œç»„åˆï¼Œè€Œä¸æ˜¯åƒGCCé‚£æ ·ï¼Œå‰ç«¯ã€ä¼˜åŒ–å™¨ã€åç«¯éƒ½æ˜¯ä¸€ä½“çš„ï¼Œä¸å¯åˆ†å‰²ã€‚</p><p>PASSï¼šç¼–è¯‘å™¨å¯¹æºä»£ç è¿›è¡Œå®Œæ•´çš„æ‰«æï¼Œè¿›è¡Œä¼˜åŒ–å’Œåˆ†æçš„æ­¥éª¤<br>IRï¼šIntermediate Representation ä¸­é—´è¡¨è¾¾</p><p>ç¼–è¯‘å™¨åŸºæœ¬ç»“æ„ï¼ˆä¸»è¦æ˜¯LLVMï¼ŒGCCåˆ†çš„æ²¡æœ‰è¿™ä¹ˆæ˜ç¡®ï¼‰</p><ul><li>Front Endï¼šè¯æ³•åˆ†æã€è¯­æ³•åˆ†æï¼Œå°†æºä»£ç è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼ŒLLVMä½¿ç”¨Clangä½œä¸ºå‰ç«¯</li><li>Optimizerï¼šä¼˜åŒ–ï¼Œå°†IRè¿›è¡Œä¼˜åŒ–ï¼Œä½¿ä»£ç æ›´é«˜æ•ˆï¼ˆPASSåœ¨è¿™ä¸ªåœ°æ–¹ï¼‰</li><li>Back Endï¼šä»£ç ç”Ÿæˆï¼Œå°†IRè½¬æ¢ä¸ºç›®æ ‡ä»£ç ï¼ˆæœºå™¨ç ï¼‰</li></ul><p><img src="image.png" alt="Alt text"></p><blockquote><p>ç›¸å…³ <strong>Chris Lattnerï¼šThe Golden Age of Compilers</strong></p></blockquote><p>AIç¼–è¯‘å™¨æ˜¯ä»‹äºæœºå™¨å­¦ä¹ æ¡†æ¶ä¸ç¡¬ä»¶ä¸­é—´çš„ä¸€å±‚ï¼Œç”¨äºè§£å†³ä¼—å¤šæ¡†æ¶ä¸å¤šç§ç¡¬ä»¶ä¹‹é—´çš„é€‚é…é—®é¢˜ï¼Œä¸»è¦æ¶æ„</p><ul><li>Front-endï¼šè®¡ç®—å›¾è½¬æ¢ï¼Œå°†ä¸åŒæ¡†æ¶ä¸‹çš„æºä»£ç è¾“å‡ºä¸ºGraph IRç­‰é«˜é˜¶IRï¼ˆHLIRï¼‰ï¼Œé‡ç‚¹åœ¨äºæŠ½è±¡å‡ºç¡¬ä»¶æ— å…³çš„è®¡ç®—å’Œæ§åˆ¶æµç¨‹ï¼Œä»¥åŠæ•°æ®å¼ é‡ã€ç®—å­çš„æ”¯æŒ</li><li>Optimizerï¼šå¯¹è®¡ç®—å›¾è¿›è¡Œä¸€äº›ç®—å­èåˆã€è‡ªåŠ¨å¾®åˆ†ã€å¹¶è¡Œåˆ‡åˆ†ã€å‰ªæé‡åŒ–ç­‰ä¼˜åŒ–ï¼Œå°†é«˜é˜¶IRè½¬æ¢ä¸ºä½é˜¶IRï¼ˆLLIRï¼‰</li><li>Back-endï¼šé’ˆå¯¹ç‰¹å®šçš„æœºå™¨ï¼Œå°†ä½çº§IRè½¬æ¢ä¸ºLLVM IRï¼Œå†åˆ©ç”¨LLVMåŸºç¡€ç»“æ„ç”Ÿæˆä¼˜åŒ–çš„æœºå™¨ç </li></ul>]]></content>
    
    
    <categories>
      
      <category>work</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>LLVM</tag>
      
      <tag>MLIR</tag>
      
      <tag>TVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MLCå­¦ä¹ </title>
    <link href="/2023/09/21/MLC%E5%AD%A6%E4%B9%A0/"/>
    <url>/2023/09/21/MLC%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>é™ˆå¤©å¥‡çš„MLCè¯¾ç¨‹ï¼Œå‚è€ƒ<br><a href="https://github.com/BBuf/tvm_mlir_learn">https://github.com/BBuf/tvm_mlir_learn</a><br><a href="https://mlc.ai/zh/index.html">https://mlc.ai/zh/index.html</a><br><a href="https://space.bilibili.com/1663273796/channel/collectiondetail?sid=499979">https://space.bilibili.com/1663273796/channel/collectiondetail?sid=499979</a></p><span id="more"></span><h2 id="1-æ¦‚è¿°">1.æ¦‚è¿°</h2><p>å®šä¹‰ï¼šå°†æœºå™¨å­¦ä¹ çš„ç®—æ³•ï¼ˆæ¨¡å‹ï¼‰ä»å¼€å‘å½¢å¼ï¼ˆå¦‚pytorchã€tfç­‰é€šç”¨æ¡†æ¶ç¼–å†™çš„æ¨¡å‹æè¿°ä»¥åŠç›¸å…³æƒé‡ï¼‰ï¼Œé€šè¿‡å˜æ¢å’Œä¼˜åŒ–ï¼Œè½¬åŒ–ä¸ºéƒ¨ç½²å½¢å¼ï¼ˆå¦‚æ¨¡å‹æ”¯æ’‘ä»£ç ã€å†…å­˜æ§åˆ¶ã€æ¥å£ç­‰ï¼‰<br>å³ï¼Œå°†ç¥ç»ç½‘ç»œæ¨¡å‹è½¬å˜æˆåœ¨ç‰¹å®šç¡¬ä»¶ä¸Šè¿è¡Œçš„å¼ é‡å‡½æ•°ä»£ç </p><p>æœºå™¨å­¦ä¹ ç¼–è¯‘ç›®æ ‡ï¼š</p><ol><li>é›†æˆå’Œæœ€å°åŒ–ä¾èµ–</li><li>åˆ©ç”¨ç¡¬ä»¶åŠ é€Ÿï¼šåˆ©ç”¨åˆ°æ¯ä¸ªéƒ¨ç½²ç¯å¢ƒçš„åŸç”ŸåŠ é€ŸæŠ€æœ¯</li><li>é€šç”¨ä¼˜åŒ–</li></ol><h2 id="2-å¼ é‡ç¨‹åºæŠ½è±¡">2. å¼ é‡ç¨‹åºæŠ½è±¡</h2><p>å…ƒå¼ é‡å‡½æ•°ï¼šæœºå™¨å­¦ä¹ æ¨¡å‹æ‰§è¡Œä¸­çš„æ¯ä¸€ä¸ªæ­¥éª¤ï¼ˆæˆ–è€…è¯´ç®—å­ï¼Ÿï¼‰ï¼Œå¦‚linearã€reluã€softmax</p><p>è®¸å¤šä¸åŒçš„æŠ½è±¡å¯ä»¥è¡¨è¾¾åŒä¸€ç§å…ƒå¼ é‡å‡½æ•°ï¼Œå¦‚torch.addå’Œnumpy.addï¼ŒåŒæ—¶ï¼Œæœ‰äº›æœºå™¨å­¦ä¹ æ¡†æ¶ä¹Ÿæä¾›æ¨¡å‹çš„ç¼–è¯‘è¿‡ç¨‹ä¼˜åŒ–ï¼Œå°†å…ƒå¼ é‡å‡½æ•°è½¬å˜æˆæ›´ä¸“é—¨çš„ã€é’ˆå¯¹æ€§çš„å‡½æ•°</p><p>å¼ é‡ç¨‹åºæŠ½è±¡ï¼šä¸€ä¸ªå…¸å‹çš„å…ƒå¼ é‡å‡½æ•°å®ç°åŒ…æ‹¬ï¼š</p><ol><li>å­˜å‚¨æ•°æ®çš„å¤šç»´æ•°ç»„</li><li>é©±åŠ¨å¼ é‡è®¡ç®—çš„å¾ªç¯åµŒå¥—</li><li>è®¡ç®—è¯­å¥</li></ol><p>æ ¹æ®æŠ½è±¡å‡ºæ¥çš„å…±åŒç‰¹å¾ï¼Œå…ƒå¼ é‡å‡½æ•°å› æ­¤å¯ä»¥è¢«ä¸€ç³»åˆ—æœ‰æ•ˆçš„ç¨‹åºå˜æ¢æ‰€æ”¹å˜ï¼Œå³ä¼˜åŒ–ã€‚<br>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ„Ÿå…´è¶£çš„å¤§éƒ¨åˆ†å…ƒå¼ é‡å‡½æ•°éƒ½å…·æœ‰è‰¯å¥½çš„å¯å˜æ¢å±æ€§ã€‚</p><h3 id="TensorIRï¼šTVMä½¿ç”¨çš„å¼ é‡ç¨‹åºæŠ½è±¡">TensorIRï¼šTVMä½¿ç”¨çš„å¼ é‡ç¨‹åºæŠ½è±¡</h3><p>å‰æï¼šå¤§å¤šæ•°çš„æœºå™¨å­¦ä¹ ç¼–è¯‘å¯ä»¥è§†ä¸ºå¼ é‡å‡½æ•°ä¹‹é—´çš„å˜æ¢</p><h4 id="ç¤ºä¾‹ï¼šä¸€ä¸ªç»å…¸çš„ç‚¹ç§¯-relu-ç½‘ç»œ">ç¤ºä¾‹ï¼šä¸€ä¸ªç»å…¸çš„ç‚¹ç§¯ + relu ç½‘ç»œ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">dtype = <span class="hljs-string">&quot;float32&quot;</span><br>a_np = np.random.rand(<span class="hljs-number">128</span>, <span class="hljs-number">128</span>).astype(dtype)<br>b_np = np.random.rand(<span class="hljs-number">128</span>, <span class="hljs-number">128</span>).astype(dtype)<br>c_mm_relu = np.maximum(a_np @ b_np, <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p>åœ¨åº•å±‚ï¼Œnumpyå¯èƒ½ä½¿ç”¨å¾ªç¯å’Œç®—æœ¯è¿ç®—å®ç°ä¸Šè¿°æ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">lnumpy_mm_relu</span>(<span class="hljs-params">A: np.ndarray, B: np.ndarray, C: np.ndarray</span>):<br>    <span class="hljs-comment"># å­˜å‚¨æ•°æ®çš„å¤šç»´æ•°ç»„</span><br>    Y = np.empty((<span class="hljs-number">128</span>, <span class="hljs-number">128</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br>    <span class="hljs-comment"># é©±åŠ¨å¼ é‡è®¡ç®—çš„å¾ªç¯åµŒå¥—</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>                <span class="hljs-keyword">if</span> k == <span class="hljs-number">0</span>:<br>                    Y[i, j] = <span class="hljs-number">0</span><br>                <span class="hljs-comment"># è®¡ç®—è¯­å¥</span><br>                Y[i, j] = Y[i, j] + A[i, k] * B[k, j]<br>    <span class="hljs-comment"># é©±åŠ¨å¼ é‡è®¡ç®—çš„å¾ªç¯åµŒå¥—</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>            <span class="hljs-comment"># è®¡ç®—è¯­å¥</span><br>            C[i, j] = <span class="hljs-built_in">max</span>(Y[i, j], <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><h4 id="TensorIRå®ç°ï¼š">TensorIRå®ç°ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@tvm.script.ir_module</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModule</span>:<br><span class="hljs-meta">    @T.prim_func</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mm_relu</span>(<span class="hljs-params">A: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>),</span><br><span class="hljs-params">                B: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>),</span><br><span class="hljs-params">                C: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>)</span>):<br>        T.func_attr(&#123;<span class="hljs-string">&quot;global_symbol&quot;</span>: <span class="hljs-string">&quot;mm_relu&quot;</span>, <span class="hljs-string">&quot;tir.noalias&quot;</span>: <span class="hljs-literal">True</span>&#125;)<br>        <span class="hljs-comment"># å­˜å‚¨æ•°æ®çš„å¤šç»´æ•°ç»„ï¼ˆç¼“å†²åŒºï¼‰</span><br>        Y = T.alloc_buffer((<span class="hljs-number">128</span>, <span class="hljs-number">128</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br>        <span class="hljs-comment"># é©±åŠ¨å¼ é‡è®¡ç®—çš„å¾ªç¯åµŒå¥—</span><br>        <span class="hljs-keyword">for</span> i, j, k <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>):<br>            <span class="hljs-comment"># è®¡ç®—è¯­å¥</span><br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;Y&quot;</span>):<br>                vi = T.axis.spatial(<span class="hljs-number">128</span>, i)<br>                vj = T.axis.spatial(<span class="hljs-number">128</span>, j)<br>                vk = T.axis.reduce(<span class="hljs-number">128</span>, k)<br>                <span class="hljs-keyword">with</span> T.init():<br>                    Y[vi, vj] = T.float32(<span class="hljs-number">0</span>)<br>                Y[vi, vj] = Y[vi, vj] + A[vi, vk] * B[vk, vj]<br>        <span class="hljs-comment"># é©±åŠ¨å¼ é‡è®¡ç®—çš„å¾ªç¯åµŒå¥—</span><br>        <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">128</span>, <span class="hljs-number">128</span>):<br>            <span class="hljs-comment"># è®¡ç®—è¯­å¥</span><br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;C&quot;</span>):<br>                vi = T.axis.spatial(<span class="hljs-number">128</span>, i)<br>                vj = T.axis.spatial(<span class="hljs-number">128</span>, j)<br>                C[vi, vj] = T.<span class="hljs-built_in">max</span>(Y[vi, vj], T.float32(<span class="hljs-number">0</span>))<br></code></pre></td></tr></table></figure><p>å—æ˜¯tensorIRçš„åŸºæœ¬è®¡ç®—å•ä½ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">[block_axis] = T.axis.[axis_type]([axis_range], [mapped_value])<br></code></pre></td></tr></table></figure><p>å¦‚<code>vi = T.axis.spatial(128, i)</code> å³è¡¨ç¤ºviä¸ºiçš„æ˜ å°„ï¼ŒèŒƒå›´ä¸º(0,128)ï¼Œä¸”è¯¥å—è½´å±æ€§ä¸ºspatialï¼ˆç©ºé—´è½´ï¼‰ï¼Œè€Œvkçš„å±æ€§åˆ™ä¸ºreduceè§„çº¦è½´ã€‚ï¼ˆå¯ä»¥ç†è§£ä¸ºç©ºé—´è½´æ˜¯åŸæœ¬å°±åœ¨çš„ï¼Œè§„çº¦è½´æ˜¯åœ¨ä¸Šé¢åšæ»‘åŠ¨çš„ï¼‰</p><p>å—è½´åŠ å±æ€§çš„å¥½å¤„æ˜¯ä½¿å¾—viï¼Œvjï¼Œvkç‹¬ç«‹äºå¤–éƒ¨çš„å¾ªç¯åµŒå¥—iï¼Œjï¼Œkï¼ŒåŒæ—¶ä¹Ÿå¯¹å¤–éƒ¨å¾ªç¯æ­£ç¡®æ€§åšäº†äºŒæ¬¡éªŒè¯ã€‚åŒæ—¶è¿™äº›é™„åŠ ä¿¡æ¯ä¹Ÿæœ‰åŠ©äºæœºå™¨å­¦ä¹ ç¼–è¯‘åˆ†æï¼Œæ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æ€»æ˜¯å¯ä»¥åœ¨ç©ºé—´è½´ä¸Šåšå¹¶è¡ŒåŒ–ï¼Œä½†åœ¨è§„çº¦è½´ä¸Šåšå¹¶è¡ŒåŒ–åˆ™éœ€è¦ç‰¹å®šçš„ç­–ç•¥</p><pre><code class="hljs">å¦‚æœè§‰å¾—è‡ªå®šä¹‰å±æ€§æ¯”è¾ƒéº»çƒ¦ä¹Ÿå¯ä»¥ä¸€é”®ç»‘å®š</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># SSR means the properties of each axes are &quot;spatial&quot;, &quot;spatial&quot;, &quot;reduce&quot;</span><br>vi, vj, vk = T.axis.remap(<span class="hljs-string">&quot;SSR&quot;</span>, [i, j, k])<br></code></pre></td></tr></table></figure><h4 id="tensorIRçš„å…ƒå¼ é‡å‡½æ•°å˜æ¢">tensorIRçš„å…ƒå¼ é‡å‡½æ•°å˜æ¢</h4><p>tensorIRå¼•å…¥äº†åä¸ºScheduleçš„è¾…åŠ©ç»“æ„ï¼Œå…è®¸æˆ‘ä»¬è¿›è¡Œæ–¹ä¾¿çš„å…ƒå¼ é‡å‡½æ•°å˜æ¢</p><p>è¿™æ˜¯åŸæ¥çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> IPython<br>IPython.display.Code(MyModule.script(), language=<span class="hljs-string">&quot;python&quot;</span>)<br><br><span class="hljs-comment"># from tvm.script import ir as I</span><br><span class="hljs-comment"># from tvm.script import tir as T</span><br><span class="hljs-meta">@I.ir_module</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Module</span>:<br><span class="hljs-meta">    @T.prim_func</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mm_relu</span>(<span class="hljs-params">A: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>), B: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>), C: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>)</span>):<br>        T.func_attr(&#123;<span class="hljs-string">&quot;global_symbol&quot;</span>: <span class="hljs-string">&quot;mm_relu&quot;</span>, <span class="hljs-string">&quot;tir.noalias&quot;</span>: <span class="hljs-literal">True</span>&#125;)<br>        <span class="hljs-comment"># with T.block(&quot;root&quot;):</span><br>        Y = T.alloc_buffer((<span class="hljs-number">128</span>, <span class="hljs-number">128</span>))<br>        <span class="hljs-keyword">for</span> i, j, k <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>):<br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;Y&quot;</span>):<br>                vi, vj, vk = T.axis.remap(<span class="hljs-string">&quot;SSR&quot;</span>, [i, j, k])<br>                T.reads(A[vi, vk], B[vk, vj])<br>                T.writes(Y[vi, vj])<br>                <span class="hljs-keyword">with</span> T.init():<br>                    Y[vi, vj] = T.float32(<span class="hljs-number">0</span>)<br>                Y[vi, vj] = Y[vi, vj] + A[vi, vk] * B[vk, vj]<br>        <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">128</span>, <span class="hljs-number">128</span>):<br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;C&quot;</span>):<br>                vi, vj = T.axis.remap(<span class="hljs-string">&quot;SS&quot;</span>, [i, j])<br>                T.reads(Y[vi, vj])<br>                T.writes(C[vi, vj])<br>                C[vi, vj] = T.<span class="hljs-built_in">max</span>(Y[vi, vj], T.float32(<span class="hljs-number">0</span>))<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨Scheduleè¿›è¡Œå˜æ¢ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## ä»¥ç»™å®šçš„moduleä½œä¸ºè¾“å…¥çš„è¾…åŠ©Scheduleç±»</span><br>sch = tvm.tir.Schedule(MyModule)<br><span class="hljs-comment"># è·å–å¯¹åº”çš„å—åŠç›¸åº”å¾ªç¯çš„å¼•ç”¨</span><br>block_Y = sch.get_block(<span class="hljs-string">&quot;Y&quot;</span>, func_name=<span class="hljs-string">&quot;mm_relu&quot;</span>)<br>i, j, k = sch.get_loops(block_Y)<br><span class="hljs-comment"># å˜æ¢ï¼šå°†åŸæœ‰çš„jå¾ªç¯æ‹†åˆ†æˆä¸¤ä¸ªå¾ªç¯ï¼ˆ4è¡¨ç¤ºå†…éƒ¨å¾ªç¯é•¿åº¦ï¼‰</span><br>j0, j1 = sch.split(j, factors=[<span class="hljs-literal">None</span>, <span class="hljs-number">4</span>])<br><span class="hljs-comment"># å†æ¬¡æ£€æŸ¥ç»“æœ</span><br>IPython.display.Code(sch.mod.script(), language=<span class="hljs-string">&quot;python&quot;</span>)<br><br><span class="hljs-meta">@I.ir_module</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Module</span>:<br><span class="hljs-meta">    @T.prim_func</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mm_relu</span>(<span class="hljs-params">A: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>), B: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>), C: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>)</span>):<br>        T.func_attr(&#123;<span class="hljs-string">&quot;global_symbol&quot;</span>: <span class="hljs-string">&quot;mm_relu&quot;</span>, <span class="hljs-string">&quot;tir.noalias&quot;</span>: <span class="hljs-literal">True</span>&#125;)<br>        <span class="hljs-comment"># with T.block(&quot;root&quot;):</span><br>        Y = T.alloc_buffer((<span class="hljs-number">128</span>, <span class="hljs-number">128</span>))<br>        <span class="hljs-keyword">for</span> i, j_0, j_1, k <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">128</span>, <span class="hljs-number">32</span>, <span class="hljs-number">4</span>, <span class="hljs-number">128</span>):<br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;Y&quot;</span>):<br>                vi = T.axis.spatial(<span class="hljs-number">128</span>, i)<br>                vj = T.axis.spatial(<span class="hljs-number">128</span>, j_0 * <span class="hljs-number">4</span> + j_1)<br>                vk = T.axis.reduce(<span class="hljs-number">128</span>, k)<br>                T.reads(A[vi, vk], B[vk, vj])<br>                T.writes(Y[vi, vj])<br>                <span class="hljs-keyword">with</span> T.init():<br>                    Y[vi, vj] = T.float32(<span class="hljs-number">0</span>)<br>                Y[vi, vj] = Y[vi, vj] + A[vi, vk] * B[vk, vj]<br>        <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">128</span>, <span class="hljs-number">128</span>):<br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;C&quot;</span>):<br>                vi, vj = T.axis.remap(<span class="hljs-string">&quot;SS&quot;</span>, [i, j])<br>                T.reads(Y[vi, vj])<br>                T.writes(C[vi, vj])<br>                C[vi, vj] = T.<span class="hljs-built_in">max</span>(Y[vi, vj], T.float32(<span class="hljs-number">0</span>))<br><br><span class="hljs-comment"># è¿˜å¯ä»¥æ›´æ¢å¾ªç¯æ¬¡åº</span><br><span class="hljs-comment"># sch.reorder(j0, k, j1)</span><br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œå—ä¹‹é—´ä¹Ÿå¯ä»¥é€šè¿‡å˜æ¢å®Œæˆç»„åˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å°†å—Cæ”¾åˆ°Yçš„å†…å¾ªç¯ä¸­</span><br>block_C = sch.get_block(<span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-string">&quot;mm_relu&quot;</span>)<br><span class="hljs-comment"># æ„Ÿè§‰æ„æ€æ˜¯å°†å—Cä¸j0å¾ªç¯ç»‘å®šï¼ŒåŠj0è¿™ä¸ªç©ºé—´è½´å˜æ¢æ—¶ï¼ŒåŸæœ¬åªæœ‰Yæœ‰åŠ¨ä½œï¼Œç°åœ¨Cä¹Ÿæœ‰åŠ¨ä½œ</span><br>sch.reverse_compute_at(block_C, j0)<br>IPython.display.Code(sch.mod.script(), language=<span class="hljs-string">&quot;python&quot;</span>)<br><br><span class="hljs-meta">@I.ir_module</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Module</span>:<br><span class="hljs-meta">    @T.prim_func</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mm_relu</span>(<span class="hljs-params">A: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>), B: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>), C: T.Buffer(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">128</span>, <span class="hljs-number">128</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>)</span>):<br>        T.func_attr(&#123;<span class="hljs-string">&quot;global_symbol&quot;</span>: <span class="hljs-string">&quot;mm_relu&quot;</span>, <span class="hljs-string">&quot;tir.noalias&quot;</span>: <span class="hljs-literal">True</span>&#125;)<br>        <span class="hljs-comment"># with T.block(&quot;root&quot;):</span><br>        Y = T.alloc_buffer((<span class="hljs-number">128</span>, <span class="hljs-number">128</span>))<br>        <span class="hljs-keyword">for</span> i, j_0 <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">128</span>, <span class="hljs-number">32</span>):<br>            <span class="hljs-keyword">for</span> k, j_1 <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">128</span>, <span class="hljs-number">4</span>):<br>                <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;Y&quot;</span>):<br>                    vi = T.axis.spatial(<span class="hljs-number">128</span>, i)<br>                    vj = T.axis.spatial(<span class="hljs-number">128</span>, j_0 * <span class="hljs-number">4</span> + j_1)<br>                    vk = T.axis.reduce(<span class="hljs-number">128</span>, k)<br>                    T.reads(A[vi, vk], B[vk, vj])<br>                    T.writes(Y[vi, vj])<br>                    <span class="hljs-keyword">with</span> T.init():<br>                        Y[vi, vj] = T.float32(<span class="hljs-number">0</span>)<br>                    Y[vi, vj] = Y[vi, vj] + A[vi, vk] * B[vk, vj]<br>            <span class="hljs-keyword">for</span> ax0 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>                <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;C&quot;</span>):<br>                    vi = T.axis.spatial(<span class="hljs-number">128</span>, i)<br>                    <span class="hljs-comment"># æ³¨æ„è¿™é‡Œvjçš„å˜åŒ–ï¼ŒåŸæœ¬vj = j = j_0 * 4 + j_1ï¼Œç°åœ¨å˜æˆäº†j_0 * 4 + ax0</span><br>                    <span class="hljs-comment"># æ„Ÿè§‰æ˜¯å› ä¸ºä¸Šé¢ reverse_compute_at åªæ˜¯å°†Cä¸j0ç»‘å®šï¼Œæ‰€ä»¥j_1è¿™ä¸ªå¾ªç¯è¿˜æ˜¯åœ¨Yä¸­ï¼ŒCé‡Œè¿˜éœ€è¦å•ç‹¬å¾ªç¯ax0</span><br>                    vj = T.axis.spatial(<span class="hljs-number">128</span>, j_0 * <span class="hljs-number">4</span> + ax0)<br>                    T.reads(Y[vi, vj])<br>                    T.writes(C[vi, vj])<br>                    C[vi, vj] = T.<span class="hljs-built_in">max</span>(Y[vi, vj], T.float32(<span class="hljs-number">0</span>))<br><br></code></pre></td></tr></table></figure><p>æ­¤å¤–è¿˜ä»‹ç»äº†å¦ä¸€ç§åŸè¯­decompose_reductionï¼Œç”¨äºå°†è¯­å—ä¸­å…ƒç´ çš„åˆå§‹åŒ–ä¸è§„çº¦æ›´æ–°åˆ†å¼€ï¼š<br>è¿™ä¹Ÿæ˜¯ TVM åœ¨ä»¥åç¼–è¯‘çš„æ—¶å€™éšå¼åšçš„ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥çš„ä¸»è¦ç›®çš„æ˜¯è®©å®ƒæ˜¾å¼ï¼Œçœ‹çœ‹æœ€ç»ˆæ•ˆæœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å°†å—Yä¸­çš„åˆå§‹åŒ–ä¸å¾ªç¯kæ— å…³(kæ˜¯è§„çº¦è½´)</span><br>sch.decompose_reduction(block_Y, k)<br>IPython.display.Code(sch.mod.script(), language=<span class="hljs-string">&quot;python&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lnumpy_mm_relu_v3</span>(<span class="hljs-params">A: np.ndarray, B: np.ndarray, C: np.ndarray</span>):<br>    Y = np.empty((<span class="hljs-number">128</span>, <span class="hljs-number">128</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>        <span class="hljs-keyword">for</span> j0 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>):<br>            <span class="hljs-comment"># Y_init</span><br>            <span class="hljs-keyword">for</span> j1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>                j = j0 * <span class="hljs-number">4</span> + j1<br>                <span class="hljs-comment"># æ­¤æ—¶åˆå§‹åŒ–åœ¨kå¾ªç¯ä¹‹å‰å°±å·²ç»åšå¥½</span><br>                Y[i, j] = <span class="hljs-number">0</span><br>            <span class="hljs-comment"># Y_update</span><br>            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>                <span class="hljs-keyword">for</span> j1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>                    j = j0 * <span class="hljs-number">4</span> + j1<br>                    Y[i, j] = Y[i, j] + A[i, k] * B[k, j]<br>            <span class="hljs-comment"># C</span><br>            <span class="hljs-keyword">for</span> j1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>                j = j0 * <span class="hljs-number">4</span> + j1<br>                C[i, j] = <span class="hljs-built_in">max</span>(Y[i, j], <span class="hljs-number">0</span>)<br><br>c_np = np.empty((<span class="hljs-number">128</span>, <span class="hljs-number">128</span>), dtype=dtype)<br>lnumpy_mm_relu_v3(a_np, b_np, c_np)<br>np.testing.assert_allclose(c_mm_relu, c_np, rtol=<span class="hljs-number">1e-5</span>)<br></code></pre></td></tr></table></figure><h4 id="æ„å»ºä¸è¿è¡Œ">æ„å»ºä¸è¿è¡Œ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ä½¿ç”¨llvmå°†æ¨¡å‹ç¼–è¯‘åˆ°æœ¬æœºå¹³å°</span><br>rt_lib = tvm.build(MyModule, target=<span class="hljs-string">&quot;llvm&quot;</span>)<br><br><span class="hljs-comment"># ç”¨äºå­˜å‚¨è¾“å…¥å’Œè¾“å‡ºçš„TVM NDArray</span><br>a_nd = tvm.nd.array(a_np)<br>b_nd = tvm.nd.array(b_np)<br>c_nd = tvm.nd.empty((<span class="hljs-number">128</span>, <span class="hljs-number">128</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br><br><span class="hljs-comment"># è°ƒç”¨ç¼–è¯‘å¥½çš„å‡½æ•°</span><br>func_mm_relu = rt_lib[<span class="hljs-string">&quot;mm_relu&quot;</span>]<br>func_mm_relu(a_nd, b_nd, c_nd)<br><span class="hljs-comment"># å°†TVMä¸numpyçš„ç»“æœè¿›è¡Œæ¯”è¾ƒ</span><br>np.testing.assert_allclose(c_mm_relu, c_nd.numpy(), rtol=<span class="hljs-number">1e-5</span>)<br><br><span class="hljs-comment"># è°ƒç”¨TVMå˜æ¢åçš„å‡½æ•°ï¼Œç»§ç»­æ¯”è¾ƒ</span><br>rt_lib_after = tvm.build(sch.mod, target=<span class="hljs-string">&quot;llvm&quot;</span>)<br>rt_lib_after[<span class="hljs-string">&quot;mm_relu&quot;</span>](a_nd, b_nd, c_nd)<br>np.testing.assert_allclose(c_mm_relu, c_nd.numpy(), rtol=<span class="hljs-number">1e-5</span>)<br></code></pre></td></tr></table></figure><p>åœ¨æœ€åçš„ç»“æœä¸­ï¼ŒTVMå˜æ¢åçš„å‡½æ•°è¿è¡Œæ—¶é—´ç›¸æ¯”åŸå…ˆçš„TVMå‡½æ•°å¤§å¹…ç¼©çŸ­ï¼Œä¸ºä»€ä¹ˆä¸åŒçš„å¾ªç¯å˜ä½“ä¼šå¯¼è‡´ä¸åŒçš„æ—¶é—´æ€§èƒ½å‘¢ï¼Ÿ</p><p>å…³é”®åœ¨äºCPUçš„è®¿å­˜ç­–ç•¥ï¼Œç”±äºå±€éƒ¨æ€§åŸç†ï¼ŒCPUåœ¨è¯»å–å†…å­˜æŸå…ƒç´ æ—¶ä¼šå°è¯•å°†è¯¥å…ƒç´ é™„è¿‘çš„å…ƒç´ ä¸€èµ·è·å–åˆ°ç¼“å­˜ä¸­ï¼ˆcacheå—ï¼Ÿç‰¹ä¹ˆOSå¿«å¿˜å¹²å‡€äº†ğŸ˜…ï¼‰ã€‚å› æ­¤å…·æœ‰è¿ç»­å†…å­˜è®¿é—®çš„ä»£ç é€šå¸¸æ¯”éšæœºè®¿é—®å†…å­˜ä¸åŒéƒ¨åˆ†çš„ä»£ç æ›´å¿«ã€‚</p><h2 id="3-ç«¯åˆ°ç«¯çš„æ¨¡å‹æ‰§è¡Œ">3. ç«¯åˆ°ç«¯çš„æ¨¡å‹æ‰§è¡Œ</h2><p>ç°åœ¨è€ƒè™‘ä¸€ä¸ªåŸºç¡€çš„ä¸¤å±‚ç¥ç»ç½‘ç»œï¼Œç”±2ä¸ªMLPå’Œ1ä¸ªreluç»„æˆï¼ˆç®€åŒ–é—®é¢˜ï¼Œåˆ é™¤æœ€åçš„softmaxï¼‰</p><p>numpyå®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">numpy_mlp</span>(<span class="hljs-params">data, w0, b0, w1, b1</span>):<br>    lv0 = data @ w0.T + b0<br>    lv1 = np.maximum(lv0, <span class="hljs-number">0</span>)<br>    lv2 = lv1 @ w1.T + b1<br>    <span class="hljs-keyword">return</span> lv2<br><br>res = numpy_mlp(img.reshape(<span class="hljs-number">1</span>, <span class="hljs-number">784</span>),<br>                mlp_params[<span class="hljs-string">&quot;w0&quot;</span>],<br>                mlp_params[<span class="hljs-string">&quot;b0&quot;</span>],<br>                mlp_params[<span class="hljs-string">&quot;w1&quot;</span>],<br>                mlp_params[<span class="hljs-string">&quot;b1&quot;</span>])<br></code></pre></td></tr></table></figure><p>åº•å±‚å®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">lnumpy_linear0</span>(<span class="hljs-params">X: np.ndarray, W: np.ndarray, B: np.ndarray, Z: np.ndarray</span>):<br>    Y = np.empty((<span class="hljs-number">1</span>, <span class="hljs-number">128</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">784</span>):<br>                <span class="hljs-keyword">if</span> k == <span class="hljs-number">0</span>:<br>                    Y[i, j] = <span class="hljs-number">0</span><br>                Y[i, j] = Y[i, j] + X[i, k] * W[j, k]<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>            Z[i, j] = Y[i, j] + B[j]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lnumpy_relu0</span>(<span class="hljs-params">X: np.ndarray, Y: np.ndarray</span>):<br>     <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>            Y[i, j] = np.maximum(X[i, j], <span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lnumpy_linear1</span>(<span class="hljs-params">X: np.ndarray, W: np.ndarray, B: np.ndarray, Z: np.ndarray</span>):<br>    Y = np.empty((<span class="hljs-number">1</span>, <span class="hljs-number">10</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">128</span>):<br>                <span class="hljs-keyword">if</span> k == <span class="hljs-number">0</span>:<br>                    Y[i, j] = <span class="hljs-number">0</span><br>                Y[i, j] = Y[i, j] + X[i, k] * W[j, k]<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>            Z[i, j] = Y[i, j] + B[j]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lnumpy_mlp</span>(<span class="hljs-params">data, w0, b0, w1, b1</span>):<br>    lv0 = np.empty((<span class="hljs-number">1</span>, <span class="hljs-number">128</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br>    lnumpy_linear0(data, w0, b0, lv0)<br><br>    lv1 = np.empty((<span class="hljs-number">1</span>, <span class="hljs-number">128</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br>    lnumpy_relu0(lv0, lv1)<br><br>    out = np.empty((<span class="hljs-number">1</span>, <span class="hljs-number">10</span>), dtype=<span class="hljs-string">&quot;float32&quot;</span>)<br>    lnumpy_linear1(lv1, w1, b1, out)<br>    <span class="hljs-keyword">return</span> out<br><br>result =lnumpy_mlp(<br>    img.reshape(<span class="hljs-number">1</span>, <span class="hljs-number">784</span>),<br>    mlp_params[<span class="hljs-string">&quot;w0&quot;</span>],<br>    mlp_params[<span class="hljs-string">&quot;b0&quot;</span>],<br>    mlp_params[<span class="hljs-string">&quot;w1&quot;</span>],<br>    mlp_params[<span class="hljs-string">&quot;b1&quot;</span>])<br><br>pred_kind = result.argmax(axis=<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Low-level Numpy MLP Prediction:&quot;</span>, class_names[pred_kind[<span class="hljs-number">0</span>]])<br></code></pre></td></tr></table></figure><p>è¯¥æ¨¡å‹çš„TVMScriptå®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@tvm.script.ir_module</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModule</span>:<br><span class="hljs-meta">    @T.prim_func</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">relu0</span>(<span class="hljs-params">x: T.handle, y: T.handle</span>):<br>        n = T.int64()<br>        X = T.match_buffer(x, (<span class="hljs-number">1</span>, n), <span class="hljs-string">&quot;float32&quot;</span>)<br>        Y = T.match_buffer(y, (<span class="hljs-number">1</span>, n), <span class="hljs-string">&quot;float32&quot;</span>)<br>        <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">1</span>, n):<br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;Y&quot;</span>):<br>                vi, vj = T.axis.remap(<span class="hljs-string">&quot;SS&quot;</span>, [i, j])<br>                Y[vi, vj] = T.<span class="hljs-built_in">max</span>(X[vi, vj], T.float32(<span class="hljs-number">0</span>))<br><br><span class="hljs-meta">    @T.prim_func</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">linear0</span>(<span class="hljs-params">x: T.handle,</span><br><span class="hljs-params">                w: T.handle,</span><br><span class="hljs-params">                b: T.handle,</span><br><span class="hljs-params">                z: T.handle</span>):<br>        m, n, k = T.int64(), T.int64(), T.int64()<br>        X = T.match_buffer(x, (<span class="hljs-number">1</span>, m), <span class="hljs-string">&quot;float32&quot;</span>)<br>        W = T.match_buffer(w, (n, m), <span class="hljs-string">&quot;float32&quot;</span>)<br>        B = T.match_buffer(b, (n, ), <span class="hljs-string">&quot;float32&quot;</span>)<br>        Z = T.match_buffer(z, (<span class="hljs-number">1</span>, n), <span class="hljs-string">&quot;float32&quot;</span>)<br>        Y = T.alloc_buffer((<span class="hljs-number">1</span>, n), <span class="hljs-string">&quot;float32&quot;</span>)<br>        <span class="hljs-keyword">for</span> i, j, k <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">1</span>, n, m):<br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;Y&quot;</span>):<br>                vi, vj, vk = T.axis.remap(<span class="hljs-string">&quot;SSR&quot;</span>, [i, j, k])<br>                <span class="hljs-keyword">with</span> T.init():<br>                    Y[vi, vj] = T.float32(<span class="hljs-number">0</span>)<br>                Y[vi, vj] = Y[vi, vj] + X[vi, vk] * W[vj, vk]<br>        <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> T.grid(<span class="hljs-number">1</span>, n):<br>            <span class="hljs-keyword">with</span> T.block(<span class="hljs-string">&quot;Z&quot;</span>):<br>                vi, vj = T.axis.remap(<span class="hljs-string">&quot;SS&quot;</span>, [i, j])<br>                Z[vi, vj] = Y[vi, vj] + B[vj]<br><br><span class="hljs-meta">    @R.function</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">x: R.Tensor(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-number">1</span>, <span class="hljs-string">&quot;m&quot;</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>),</span><br><span class="hljs-params">             w0: R.Tensor(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-string">&quot;n&quot;</span>, <span class="hljs-string">&quot;m&quot;</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>),</span><br><span class="hljs-params">             b0: R.Tensor(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-string">&quot;n&quot;</span>, </span>), <span class="hljs-string">&quot;float32&quot;</span></span>),</span><br><span class="hljs-params">             w1: R.Tensor(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-string">&quot;k&quot;</span>, <span class="hljs-string">&quot;n&quot;</span></span>), <span class="hljs-string">&quot;float32&quot;</span></span>),</span><br><span class="hljs-params">             b1: R.Tensor(<span class="hljs-params">(<span class="hljs-params"><span class="hljs-string">&quot;k&quot;</span>, </span>), <span class="hljs-string">&quot;float32&quot;</span></span>)</span>):<br>        m, n, k = T.int64(), T.int64(), T.int64()<br>        <span class="hljs-keyword">with</span> R.dataflow():<br>            lv0 = R.call_dps_packed(<span class="hljs-string">&quot;linear0&quot;</span>, (x, w0, b0), R.Tensor((<span class="hljs-number">1</span>, n), <span class="hljs-string">&quot;float32&quot;</span>))<br>            lv1 = R.call_dps_packed(<span class="hljs-string">&quot;relu0&quot;</span>, (lv0, ), R.Tensor((<span class="hljs-number">1</span>, n), <span class="hljs-string">&quot;float32&quot;</span>))<br>            out = R.call_dps_packed(<span class="hljs-string">&quot;linear0&quot;</span>, (lv1, w1, b1), R.Tensor((<span class="hljs-number">1</span>, k), <span class="hljs-string">&quot;float32&quot;</span>))<br>            R.output(out)<br>        <span class="hljs-keyword">return</span> out<br></code></pre></td></tr></table></figure><p>å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ <code>@R.function</code> å³Relexå‡½æ•°ï¼Œæ˜¯ä¸€ç§è¡¨ç¤ºä¸Šå±‚ç¥ç»ç½‘ç»œæ‰§è¡Œçš„å…¨æ–°æŠ½è±¡</p><p><img src="image.png" alt="Alt text"></p><p>æ³¨æ„åˆ°ï¼Œå…¶ä¸­<code>call_dps_packed</code>å°†æˆ‘ä»¬çš„å…ƒå‡½æ•°åµŒå…¥åˆ°è®¡ç®—å›¾ä¸­ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯æ»¡è¶³<strong>ç›®æ ‡ä¼ é€’</strong>çš„è°ƒç”¨çº¦å®šï¼Œå³ pure æˆ– side-effect free ï¼Œå‡½æ•°åªä»å…¶è¾“å…¥ä¸­è¯»å–æ•°æ®å¹¶è¾“å‡ºè¿”å›ç»“æœï¼Œè€Œä¸æ”¹å˜ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ï¼Œè¿™å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬éšè—è°ƒç”¨åº•å±‚å…ƒå‡½æ•°çš„ç»†èŠ‚</p><p>å¦‚æœåªæ˜¯åƒnumpyå®ç°ä¸­é‚£æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">lnumpy_linear0(data, w0, b0, lv0)<br>lnumpy_relu0(lv0, lv1)<br>lnumpy_linear1(lv1, w1, b1, out)<br></code></pre></td></tr></table></figure><p>è®¡ç®—å›¾å¯èƒ½ä¼šå˜æˆè¿™æ ·ï¼šlv0æ—¢æ˜¯<code>lnumpy_linear0</code>çš„å…¥å‚ï¼Œä¹Ÿæ˜¯<code>lnumpy_relu0</code>çš„å…¥å‚ï¼Œå…¶ä½™åŒç†<br><img src="image-1.png" alt="Alt text"></p><blockquote><p>è®¡ç®—å›¾é€šå¸¸å…·æœ‰ä»¥ä¸‹æ€§è´¨ï¼š</p><ul><li>æ¡†çš„æ¯ä¸ªè¾“å…¥è¾¹å¯¹åº”äºæ“ä½œçš„è¾“å…¥</li><li>æ¯ä¸ªå‡ºè¾¹å¯¹åº”äºæ“ä½œçš„è¾“å‡º</li><li>æ¯ä¸ªæ“ä½œå¯ä»¥ä»»æ„é‡æ–°æ’åºï¼Œç›´åˆ°è¾¹ç¼˜çš„æ‹“æ‰‘é¡ºåº</li></ul></blockquote><p>å½“ç„¶ï¼Œnumpyçš„åº•å±‚åŒæ ·ä¹Ÿä½¿ç”¨äº†å¦‚<code>lnumpy_call_dps_packed</code>çš„ç±»ä¼¼è°ƒç”¨</p><p>æ­¤å¤–ï¼Œæ³¨æ„<code>with R.dataflow():</code> æ˜¯ä¸€ä¸ªå¸®åŠ©æˆ‘ä»¬æ ‡æ³¨ç¨‹åºè®¡ç®—å›¾èŒƒå›´çš„æ–¹å¼ï¼Œåé¢çš„æ„å»ºè¿è¡Œå°±ä¸å¤šè¯´äº†</p><h2 id="4-è‡ªåŠ¨ç¨‹åºä¼˜åŒ–">4. è‡ªåŠ¨ç¨‹åºä¼˜åŒ–</h2><p>è¿™ä¸€ç« ä¸»è¦è®²éšæœºè°ƒåº¦å˜æ¢ï¼Œå½“æˆ‘ä»¬æ— æ³•å†³å®šåŸå¼ é‡å‡½æ•°ä¼˜åŒ–çš„æ¯ä¸€ä¸ªç»†èŠ‚æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æœºå™¨çš„ä¸€äº›<strong>éšæœºå˜æ¢</strong>åšæ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">stochastic_schedule_mm</span>(<span class="hljs-params">sch: tvm.tir.Schedule</span>):<br>    block_C = sch.get_block(<span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-string">&quot;main&quot;</span>)<br>    i, j, k = sch.get_loops(block=block_C)<br>    <span class="hljs-comment"># æ³¨æ„ j_factors æ²¡æœ‰ä½¿ç”¨å›ºå®šçš„[none,4]ï¼Œè€Œæ˜¯é‡‡ç”¨éšæœºå€¼</span><br>    j_factors = sch.sample_perfect_tile(loop=j, n=<span class="hljs-number">2</span>)<br>    j_0, j_1 = sch.split(loop=j, factors=j_factors)<br>    sch.reorder(i, j_0, k, j_1)<br>    sch.decompose_reduction(block_C, k)<br>    <span class="hljs-keyword">return</span> sch<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œç”¨åˆ°äº† sch.sample_perfect_tile æ¥éšæœºæ‹†åˆ†å¾ªç¯ã€‚å®ƒä¼šå°†è¾“å…¥çš„å¾ªç¯çš„é•¿åº¦è¿›è¡Œéšæœºåˆ†å‰²ï¼Œä¾‹å¦‚åŸå§‹j =128 æ—¶ï¼Œå°±å¯ä»¥åˆ†å‰²ä¸º [8,16]ã€[32,4]ã€[2,64] ç­‰ç­‰ï¼Œå¯ä»¥å‘ç°ï¼Œæ¯æ¬¡è¿è¡Œæ—¶è¯¥å‡½æ•°çš„é‡‡æ ·éƒ½ä¸ä¸€æ ·</p><p>æ­¤å¤–è¿˜è®²äº†ä¸€äº›éšæœºæœç´¢çš„ä¸œè¥¿ï¼Œå¤§æ¦‚ç±»ä¼¼è¶…å‚æ•°çš„ç½‘æ ¼æœç´¢ä¹‹ç±»çš„ï¼Œåœ¨TVMé‡Œå«<code>meta_schedule</code>ï¼Œä¸»è¦è¿˜åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p><ol><li>è·¨å¤šä¸ªè¿›ç¨‹çš„å¹¶è¡ŒåŸºå‡†æµ‹è¯•</li><li>ä½¿ç”¨ä»£ä»·æ¨¡å‹<code>cost model</code>è¿›è¡Œä»£ä»·è¯„ä¼°ï¼Œè¿™æ ·å¯ä»¥é¿å…æ¯ç»„éƒ½è¿›è¡ŒåŸºå‡†æµ‹è¯•</li><li>æ ¹æ®å†å²è½¨è¿¹æ¥è¿›è¡Œé—ä¼ æœç´¢ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½éšæœºé‡‡æ ·</li></ol><p>å…³é”®æ€æƒ³å°±æ˜¯ä½¿ç”¨éšæœºå˜æ¢æ¥æŒ‡å®šå¥½çš„ç¨‹åºçš„æœç´¢ç©ºé—´ï¼Œä½¿ç”¨ <code>tune_tir</code> API å¸®åŠ©åœ¨æœç´¢ç©ºé—´å†…æœç´¢å¹¶æ‰¾åˆ°æœ€ä¼˜çš„è°ƒåº¦å˜æ¢</p><blockquote><p><strong>å‰é¢å‡ ç« å†…å®¹æ€»ç»“ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆé€šè¿‡ç¼–è¯‘å¯ä»¥ä½¿æ¨¡å‹è¿è¡Œæ›´å¿«ï¼ˆcacheç©ºé—´å±€éƒ¨æ€§ï¼‰ï¼Œä»¥åŠæ€ä¹ˆæ ·ç¼–è¯‘å¯ä»¥æ›´å¿«ï¼ˆå…ƒå¼ é‡å‡½æ•°å˜æ¢ï¼‰ï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº†ä¸€äº›éšæœºå˜æ¢çš„æ–¹æ³•ï¼ˆç½‘æ ¼æœç´¢ï¼‰ï¼Œæ„Ÿè§‰éšæœºå˜æ¢çš„ç®—æ³•æ‰æ˜¯MLCæ€§èƒ½çš„æ ¸å¿ƒï¼Œä¹Ÿå°±æ˜¯è‡ªåŠ¨è°ƒä¼˜ï¼ŒTVMåé¢ä¼¼ä¹ç”¨åˆ°äº†ä¸€äº› autoTVMã€autoSchedule ä¹‹ç±»çš„æ–¹æ³•è¿›è¡Œ auto tuneï¼Œè¿™ä¹Ÿæ˜¯æˆ‘éœ€è¦é‡ç‚¹å…³æ³¨çš„éƒ¨åˆ†</strong></p></blockquote><h2 id="5-ä¸æœºå™¨å­¦ä¹ æ¡†æ¶çš„æ•´åˆ">5. ä¸æœºå™¨å­¦ä¹ æ¡†æ¶çš„æ•´åˆ</h2><p>å¦‚ä½•å°†æœºå™¨å­¦ä¹ æ¨¡å‹ä»ç°æœ‰æ¡†æ¶å¼•å…¥MLCï¼Œä¸€äº›APIçš„åŸºç¡€æ•™ç¨‹ï¼Œå‚è€ƒ <a href="https://mlc.ai/zh/chapter_integration/index.html">https://mlc.ai/zh/chapter_integration/index.html</a></p><h2 id="6-GPUç¡¬ä»¶åŠ é€Ÿ">6. GPUç¡¬ä»¶åŠ é€Ÿ</h2><p>åœ¨GPUç¯å¢ƒä¸‹çš„MLCæµç¨‹ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¸»è¦è®¨è®ºCUDAï¼Œç¬¬äºŒéƒ¨åˆ†è®¨è®ºä¸“é—¨çš„GPUç¯å¢ƒï¼Œåé¢å†çœ‹å§</p><h2 id="7-è®¡ç®—å›¾ä¼˜åŒ–">7. è®¡ç®—å›¾ä¼˜åŒ–</h2><p>æä¾›äº†ä¸€äº›ç®—å­èåˆçš„åŸºç¡€ä»£ç ï¼Œä¹Ÿä¸å¤ªæƒ³çœ‹</p>]]></content>
    
    
    <categories>
      
      <category>work</category>
      
    </categories>
    
    
    <tags>
      
      <tag>TVM</tag>
      
      <tag>MLC</tag>
      
      <tag>è¯¾ç¨‹ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œçŠ¶æ€æ£€æŸ¥</title>
    <link href="/2023/09/16/%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5/"/>
    <url>/2023/09/16/%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘fpsè€æ˜¯å»¶è¿Ÿ+æ‰åŒ…ï¼ˆæŠŠæŠŠè¢«ä¸€æªå¤´æƒ³å¿…ä¸æ˜¯æˆ‘çš„é—®é¢˜ï¼‰ï¼ŒåŠ ä¸Šç½‘å£æ¥è§¦ä¸è‰¯ä¸€ç›´ä¸å¥½ç¡®å®šæºå¤´åœ¨å“ªï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹é—®é¢˜å®šä½çš„è¿‡ç¨‹</p><span id="more"></span><h2 id="åŸå› åˆ†æï¼š">åŸå› åˆ†æï¼š</h2><ul><li>æ•°æ®ä¼ è¾“æµç¨‹ï¼š<br>æœ¬åœ°ä¸»æœº â€” æœ¬åœ°è·¯ç”±ï¼ˆå¦‚æœæœ‰ï¼‰ â€” ç½‘å…³ â€” å¤–éƒ¨ç½‘ç»œä¸­è½¬ â€” ç›®æ ‡ä¸»æœº</li></ul><p>å¾ˆæ˜¾ç„¶çªç„¶çš„å»¶è¿Ÿå’Œæ‰åŒ…å‡ ä¹ä¸å¯èƒ½æ˜¯å¤–éƒ¨ç½‘ç»œä¸­è½¬å’Œç›®æ ‡ä¸»æœºçš„é—®é¢˜ï¼ŒåŠ ä¸Šç›®å‰æ˜¯ç›´è¿å®½å¸¦ï¼Œé—®é¢˜åªå¯èƒ½å‡ºåœ¨ä¸»æœº &lt;â€”&gt; ç½‘å…³ä¸Š</p><h2 id="é—®é¢˜æ’æŸ¥ï¼š">é—®é¢˜æ’æŸ¥ï¼š</h2><h3 id="1-æŸ¥çœ‹è‡ªèº«ç½‘ç»œé…ç½®ï¼š">1. æŸ¥çœ‹è‡ªèº«ç½‘ç»œé…ç½®ï¼š</h3><p><img src="0.png" alt=""></p><p>æœ¬åœ°ä¸»æœºæœ‰ä¸¤æ¡è¿æ¥ï¼Œç½‘å…³åˆ†åˆ«ä¸º192.168.14.1ï¼ˆç½‘å£ï¼‰å’Œ172.168.15.1(wifi)</p><h3 id="2-è¿è¡Œä»»ä¸€å‡ºç°æ‰åŒ…çš„åº”ç”¨">2. è¿è¡Œä»»ä¸€å‡ºç°æ‰åŒ…çš„åº”ç”¨</h3><h3 id="3-ä»»åŠ¡ç®¡ç†å™¨ä¸­çš„èµ„æºç›‘è§†å™¨ï¼Œæ‰¾åˆ°è¿›ç¨‹PIDä»¥åŠé€šä¿¡çš„å¤–éƒ¨IP">3. ä»»åŠ¡ç®¡ç†å™¨ä¸­çš„èµ„æºç›‘è§†å™¨ï¼Œæ‰¾åˆ°è¿›ç¨‹PIDä»¥åŠé€šä¿¡çš„å¤–éƒ¨IP</h3><p><img src="1.png" alt=""></p><p>æˆ‘ä¹Ÿä¸çŸ¥é“è¿™ä¹ˆå¤šIPå“ªä¸€ä¸ªæ˜¯å¯¼è‡´æ‰åŒ…å’Œå»¶è¿Ÿçš„ã€‚ã€‚å…ˆæ‰¾æ”¶å‘é«˜çš„å§ 180.102.211.22 121.229.89.178</p><h3 id="4-netstatæŸ¥çœ‹è¯¥è¿›ç¨‹çš„ç½‘ç»œç›¸å…³ä¿¡æ¯">4. netstatæŸ¥çœ‹è¯¥è¿›ç¨‹çš„ç½‘ç»œç›¸å…³ä¿¡æ¯</h3><p><img src="2.png" alt=""></p><p>å¾ˆæ˜¾ç„¶ä¸»æœºæ˜¯ç”¨çš„192.1168.14.1ä¸Šçš„æŸä¸ªç«¯å£å‘å¤–éƒ¨é€šä¿¡ï¼Œå¹¶ä¸”é—®é¢˜å¤§æ¦‚ç‡å‡ºç°åœ¨ä¸121.229ä¸180.102çš„é€šä¿¡ä¸Š</p><h3 id="5-tracertæŸ¥çœ‹è·¯ç”±ï¼ˆpathpingä¹Ÿè¡Œï¼‰">5. tracertæŸ¥çœ‹è·¯ç”±ï¼ˆpathpingä¹Ÿè¡Œï¼‰</h3><table><thead><tr><th style="text-align:center"><img src="4.png" alt=""></th><th style="text-align:center"><img src="5.png" alt=""></th></tr></thead></table><p>ä¸¤æ¬¡åœ¨èµ°è¿‡ç½‘å£åï¼Œéƒ½åˆç»è¿‡äº†ä¸€ä¸ªæœ¬åœ°IP 100.69.0.1 ï¼Œä¼°è®¡æ˜¯ä¸€æ•´æ ‹æ¥¼æˆ–è€…æœ¬å±‚å±€åŸŸç½‘ç»Ÿä¸€ä¹‹åçš„äºŒçº§ç½‘å…³ï¼Œç»è¿‡è¿™ä¸ªæ‰åˆ°å¤–éƒ¨ç½‘ç»œ</p><h3 id="6-ping">6. ping</h3><p>åˆ†åˆ« ping -t äº†ä¸€ä¸‹ç½‘å…³å’Œ100.69ä¸¤ä¸ªipï¼Œå‘ç°åˆ°ç½‘å…³åŸºæœ¬ä¸Šæ²¡é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ä¸»æœºåˆ°ç½‘å£çš„å…¨è¿‡ç¨‹æµç•…</p><p>æ¯æ¬¡å‡ºç°æ‰åŒ…æ—¶ï¼Œåˆ°100.69ä¹Ÿä¼šå‡ºç°è¯·æ±‚è¶…æ—¶ï¼Œé—®é¢˜å°±åœ¨ç½‘å£åˆ°100.69è¿™æ®µï¼Œåˆ†ææœ‰ä¸¤ç§å¯èƒ½ï¼š</p><ol><li>ç½‘å£åˆ°100.69çº¿è·¯å¯¼è‡´ä¸¢åŒ…</li><li>100.69è´Ÿè½½è¿‡é«˜ï¼Œæ”¶åˆ°æ•°æ®åè½¬å‘ä¸¢åŒ…</li></ol><h2 id="é—®é¢˜è§£å†³">é—®é¢˜è§£å†³</h2><p>ä¸ä¿¡é‚ªï¼Œç›´æ¥å»æ¥¼ä¸Šçš„ä¸¤é—´ç©ºæˆ¿å’Œæœ¬å±‚çš„å¦ä¸€é—´ç©ºæˆ¿è¯•äº†ä¸€ä¸‹ï¼Œæ¥¼ä¸Šç»ç½‘å…³åç»Ÿä¸€å‘å‘100.65.0.1ï¼Œæ¥¼ä¸‹ç»Ÿä¸€å‘å‘100.69.0.1ï¼Œä¸”æœ¬å±‚å…¶ä»–æˆ¿é—´ping 100.69ä¹Ÿä¼šå‡ºç°è¶…æ—¶æˆ–å»¶è¿Ÿè¿‡é«˜é—®é¢˜ï¼Œæœäº†ï¼Œç¡®å®æ˜¯å±‚çº§ç½‘å…³è´Ÿè½½è¿‡é«˜çš„åŸå› </p><h2 id="æœ‰çº¿å’ŒwifiåŒç½‘å åŠ ">æœ‰çº¿å’ŒwifiåŒç½‘å åŠ </h2><p>å‚è€ƒï¼š<a href="https://www.zhihu.com/question/294289602/answer/2912972037">https://www.zhihu.com/question/294289602/answer/2912972037</a></p><p>ç³»ç»Ÿä¼šä¼˜å…ˆé€‰æ‹©è·ƒç‚¹æ•°å°çš„ç½‘ç»œè¿›è¡Œä¼ è¾“ï¼Œ route printæŸ¥çœ‹è¿æ¥ç½‘ç»œè·ƒç‚¹æ•°ï¼Œä¹‹åå°†ä¸¤ä¸ªç½‘ç»œè·ƒç‚¹æ•°è®¾ç½®ä¸ºç›¸åŒå³å¯</p><p>æ„Ÿè§‰å¾ˆæ‰¯ï¼Œå®æµ‹ä¸‹è½½é€Ÿåº¦ä¸å˜ï¼Œä¸Šä¼ é€Ÿåº¦ç¿»å€ã€‚ã€‚ã€‚ç‰›çš®</p>]]></content>
    
    
    <categories>
      
      <category>work</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®°å½•</tag>
      
      <tag>ç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GPGPAé˜…è¯»</title>
    <link href="/2023/09/14/GPGPA%E9%98%85%E8%AF%BB/"/>
    <url>/2023/09/14/GPGPA%E9%98%85%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[<h1>General-Purpose Graphics Processor Architectures</h1><h2 id="Abstract-Preface">Abstract &amp;&amp; Preface</h2><p>ä¸CPUç›¸æ¯”ï¼ŒGPUå¯ä»¥æ›´åŠ èšç„¦ä¸è®¡ç®—ï¼Œå› æ­¤æ€§èƒ½å’Œæ•ˆç‡æ›´é«˜ã€‚â€”â€”é€šç”¨å¯ç¼–ç¨‹GPU</p><p>ç« èŠ‚ä»‹ç»ï¼šGPUåŸºæœ¬ç»“æ„ä¸å†å² â€”â€” GPUç¼–ç¨‹æ¨¡å‹ â€”â€” GPUè®¡ç®—æ ¸å¿ƒçš„ä½“ç³»ç»“æ„ â€”â€” è®¡ç®—æ ¸å¿ƒä¸å†…å­˜ç³»ç»Ÿçš„äº¤å‰ç ”ç©¶</p><h2 id="Chapter-1-Intro">Chapter 1: Intro</h2><h3 id="1-1-è®¡ç®—åŠ é€Ÿå™¨çš„å‰æ™¯">1.1 è®¡ç®—åŠ é€Ÿå™¨çš„å‰æ™¯</h3><p>è¿‡å»ï¼Œè®¡ç®—ç³»ç»Ÿçš„æ€§èƒ½æå‡å¤§éƒ¨åˆ†ä¾èµ–äºå·¥è‰ºçš„è¿›æ­¥ï¼Œä½¿å¾—æ™¶ä½“ç®¡å°ºå¯¸ç¼©å°ï¼Œä»è€Œæå‡é›†æˆåº¦ï¼Œä½¿å¾—è¿è¡Œé€Ÿåº¦æ›´å¿«ã€‚</p><p>Dennard Scalingï¼šä»05å¹´å¼€å§‹æ™¶ä½“ç®¡ç¼©æ”¾è§„åˆ™å¤±æ•ˆã€‚å› æ­¤ä¸ºäº†æé«˜æ€§èƒ½ï¼Œéœ€è¦æ‰¾åˆ°æ›´é«˜æ•ˆçš„ç¡¬ä»¶æ¶æ„ã€‚</p><p>hardware specializationï¼šå®šåˆ¶åŒ–ç¡¬ä»¶ï¼Œå¯ä»¥ä½¿èƒ½æ•ˆæ¯”å¤§å¹…æé«˜ï¼Œä¸¤å¤§æ–¹å‘ï¼š</p><ul><li>ç¡¬ä»¶å‘é‡åŒ–ï¼Œæ¶ˆé™¤æŒ‡ä»¤å¤„ç†çš„å¼€é”€</li><li>ä¼˜åŒ–è®¡ç®—è¿‡ç¨‹ï¼Œå‡å°‘æ•°æ®è¿è¾“å¼€é”€</li></ul><p>è®¡ç®—æ¶æ„çš„å…³é”®ï¼šä¸“ä¸šåŒ–ç¡¬ä»¶å¸¦æ¥çš„æ”¶ç›Šä¸æ”¯æŒå¹¿æ³›ç¨‹åºæ‰€éœ€çš„çµæ´»æ€§ä¹‹é—´çš„å¹³è¡¡ã€‚ç›¸æ¯”äºä¸“ç”¨åŠ é€Ÿå™¨ï¼ˆä¾‹å¦‚googleçš„TPUï¼‰ï¼Œä»ç„¶éœ€è¦GPUè¿™ç§è¾ƒä¸ºé€šç”¨çš„è®¡ç®—ç¡¬ä»¶ã€‚</p><p>Turing-completeï¼šå›¾çµå®Œå¤‡ï¼Œåªè¦ç»™è¶³å¤Ÿçš„æ—¶é—´ä¸å†…å­˜ï¼ŒGPUå¯ä»¥å®Œæˆä¸€åˆ‡è¿ç®—ã€‚</p><h3 id="1-2-GPUç¡¬ä»¶åŸºç¡€">1.2 GPUç¡¬ä»¶åŸºç¡€</h3><p>GPUä¸ä¼šå®Œå…¨å–ä»£CPUï¼šGPUä¸æ˜¯ç‹¬ç«‹çš„è®¡ç®—è®¾å¤‡ï¼Œé€šå¸¸æ¥è¯´ï¼ŒCPUè´Ÿè´£åœ¨GPUä¸Šå¯åŠ¨è®¡ç®—å¹¶è´Ÿè´£GPUä¸Šçš„æ•°æ®ä¼ è¾“ã€‚å½“å‰è®¿é—®I/Oè®¾å¤‡æˆ–æä¾›OSæœåŠ¡çš„è½¯ä»¶ä¸»è¦è¿˜æ˜¯è¿è¡Œåœ¨CPUä¸Šï¼ˆè¿™äº›è½¯ä»¶ç¼ºä¹å¤§è§„æ¨¡å¹¶è¡Œæ€§ï¼‰ï¼Œå› æ­¤ï¼Œéœ€è¦é¦–å…ˆè€ƒè™‘GPUä¸CPUçš„äº¤äº’ã€‚</p><ul><li>ç‹¬ç«‹GPUï¼šä¸¤ä¸ªUå„æœ‰å„çš„memï¼ŒåŒæ—¶æ ¸å¿ƒé€šè¿‡PCIEæ€»çº¿è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚æ³¨æ„å¯¹äºç‹¬æ˜¾æ¥è¯´ï¼Œä¸¤ä¸ªUçš„memçš„DRAMæŠ€æœ¯é€šå¸¸æ˜¯ä¸ä¸€æ ·çš„ï¼ŒCPUçš„DRAMé€šå¸¸é’ˆå¯¹ä½å»¶è¿Ÿè®¿é—®è¿›è¡Œä¼˜åŒ–ï¼ˆDDRï¼‰ï¼Œè€ŒGPUçš„DRAMé€šå¸¸é’ˆå¯¹é«˜ååè¿›è¡Œä¼˜åŒ–ï¼ˆGDDRï¼‰ã€‚</li><li>é›†æˆGPUï¼šä¸¤ä¸ªUå…±äº«ä¸€ä¸ªcacheï¼Œcacheä¸ä¸€ä¸ªå†…å­˜è¿›è¡Œæ•°æ®äº¤äº’ã€‚ç”±äºå…±äº«å†…å­˜æ‰€ä»¥åªèƒ½é‡‡å–å•ä¸€æŠ€æœ¯ï¼Œé›†æˆå¼GPUé€šå¸¸æ­è½½åœ¨ä½åŠŸè€—è®¾å¤‡ä¸Šï¼Œå› æ­¤DRAMé€šå¸¸é’ˆå¯¹ä½åŠŸè€—è¿›è¡Œä¼˜åŒ–ï¼ˆLPDDRï¼‰ã€‚</li></ul><p>ä¸€ä¸ªGPUè®¡ç®—åº”ç”¨ä¼šä»CPUä¸Šå¼€å§‹ï¼Œé€šå¸¸ï¼Œè¯¥åº”ç”¨ç¨‹åºçš„CPUéƒ¨åˆ†è´Ÿè´£åˆ†é…å’Œåˆå§‹åŒ–ä¸€äº›æ•°æ®ç»“æ„ã€‚åœ¨æ—§çš„Nå¡å’ŒAå¡ä¸Šï¼ŒCPUéœ€è¦ä¸ºCPUå’ŒGPUå†…å­˜ä¸­çš„æ•°æ®ç»“æ„åˆ†é…ç©ºé—´ï¼Œå¹¶åè°ƒæ•°æ®ä»CPUmemåˆ°GPUmemçš„ç§»åŠ¨ã€‚åœ¨æ–°çš„Nå¡ï¼ˆPascalï¼Œ10ç³»ï¼‰ä¸Šçš„è½¯ç¡¬ä»¶æ”¯æŒæ•°æ®ä»Cmemåˆ°Gmemçš„è‡ªåŠ¨ä¼ è¾“ï¼Œè¿™é¡¹æŠ€æœ¯é€šè¿‡åˆ©ç”¨è™šæ‹Ÿå†…å­˜æ”¯æŒæ¥å®ç°ï¼ŒNVç§°ä¹‹ä¸ºunified memoryã€‚å¯¹äºé›†æ˜¾æ¥è¯´ä¸å­˜åœ¨æ•°æ®memä¼ è¾“çš„é—®é¢˜ï¼Œä½†æ˜¯ç”±äºä¸¤ä¸ªUå…±äº«cacheå¹¶ä¸”æœ‰äº›cacheå¯èƒ½æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤ä¹Ÿéœ€è¦å…³æ³¨ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ (cache-coherence) ã€‚</p><p>å¯åŠ¨GPUè¿ç®—ä¸€èˆ¬éœ€è¦é©±åŠ¨ç¨‹åºå®Œæˆï¼Œåœ¨GPUå¯åŠ¨è¿ç®—å‰ï¼ŒCPUé€šè¿‡é©±åŠ¨ç¨‹åºæŒ‡å®šGPUè¿è¡Œå“ªäº›ä»£ç ï¼Œè¿™äº›ä»£ç ç§°ä¸ºå†…æ ¸ï¼ˆkernelï¼‰ï¼ŒåŒæ—¶ï¼ŒCPUè¿˜éœ€è¦æŒ‡å®šçº¿ç¨‹æ•°ã€æ¯ä¸ªçº¿ç¨‹çš„æ•°æ®ä½ç½®ç­‰ç­‰ã€‚é…ç½®å®Œæ¯•åï¼ŒCPUå‘GPUå‘å‡ºä¿¡å·ï¼ŒGPUå¼€å§‹è¿ç®—ã€‚</p><p>ç°ä»£GPUç”±è®¸å¤šæ ¸å¿ƒï¼ˆSIMT Coreï¼‰ç»„æˆï¼ŒNVç§°ä¹‹ä¸ºæµå¼å¤šå¤„ç†å™¨(Streaming Multiprocessor, SM)ï¼ŒAMDç§°ä¹‹ä¸ºè®¡ç®—å•å…ƒ(compute unit)ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½æ‰§è¡Œä¸€ä¸ªä¸æ­¤æ—¶è¿è¡Œçš„å†…æ ¸ç›¸å…³çš„å•æŒ‡ä»¤å¤šçº¿ç¨‹ç¨‹åºï¼Œä¸€ä¸ªæ ¸å¿ƒå¯ä»¥è¿è¡Œä¸Šåƒä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹é€šè¿‡æš‚å­˜åŒºmemè¿›è¡Œé€šä¿¡ï¼Œå¹¶ä½¿ç”¨å¿«é€Ÿå±éšœæŠ€æœ¯ï¼ˆfast barrier operationsï¼‰è¿›è¡ŒåŒæ­¥ã€‚æ¯ä¸ªæ ¸å¿ƒåŒæ—¶è¿˜æœ‰ä¸€çº§æŒ‡ä»¤å’Œä¸€çº§ç¼“å­˜ï¼Œè¿™äº›ç¼“å­˜å¯ä»¥å……å½“å¸¦å®½è¿‡æ»¤å™¨ï¼Œå‡å°‘å‘ä½çº§åˆ«å†…å­˜çš„æµé‡ï¼Œå½“æ‹¥æœ‰å¤§é‡çº¿ç¨‹æ—¶ï¼Œå¯ä»¥éšè—ç”±äºæœ‰æ—¶æŸçº¿ç¨‹çš„ç¼“å­˜æœªå‘½ä¸­è€Œè®¿é—®å†…å­˜å¸¦æ¥çš„çš„æ€§èƒ½ä¸‹æ»‘ã€‚</p><p>é«˜è®¡ç®—ååéœ€è¦é«˜å†…å­˜å¸¦å®½çš„æ”¯æŒï¼Œè¿™åˆå¯¹å†…å­˜ç³»ç»Ÿçš„å¹¶è¡Œæ€§æå‡ºè¦æ±‚ã€‚è¿™ç§å¹¶è¡Œæ€§åˆå¤šé€šé“å†…å­˜å®ç°ï¼Œæ¯ä¸ªé€šé“ä¸å†…å­˜åˆ†åŒºä¸­çš„æœ€åä¸€çº§ç¼“å­˜ï¼ˆLLCï¼‰ç›¸è¿ï¼ŒGPUæ ¸å¿ƒé€šè¿‡ç‰‡ä¸Šäº’è¿ç½‘ç»œä¸å†…å­˜åˆ†åŒºç›¸è¿ã€‚ä¹Ÿæœ‰ä¸€äº›æ›¿ä»£çš„æ–¹æ¡ˆï¼Œä¾‹å¦‚Intelçš„Xeon Phiï¼Œå°±æ˜¯å°†LLCç›´æ¥äº¤ç”±GPUæ ¸å¿ƒåˆ†é…</p><p>å¯¹äºé«˜å¹¶å‘ä»»åŠ¡æ¥è¯´ï¼ŒGPUç›¸å¯¹è¶…æ ‡é‡æ— åºCPUæ‹¥æœ‰æ›´é«˜çš„å•ä½é¢ç§¯æ€§èƒ½ï¼Œå› ä¸ºGPUå¯ä»¥å°†å…¶èŠ¯ç‰‡é¢ç§¯çš„å¤§éƒ¨åˆ†ä¸“ç”¨äºç®—æœ¯é€»è¾‘å•å…ƒï¼Œå¹¶ç›¸åº”çš„å‡å°æ§åˆ¶é€»è¾‘çš„é¢ç§¯ã€‚</p><p>09å¹´å‡ºæ¥ä¸€ä¸ªæ€§èƒ½éšçº¿ç¨‹å˜åŒ–çš„åˆ†ææ¨¡å‹ã€‚æ¨¡å‹æ˜¾ç¤ºï¼š</p><ol><li>å½“å°‘é‡çº¿ç¨‹å…±äº«å¤§ç¼“å­˜æ—¶ï¼ˆå¦‚å¤šæ ¸CPUï¼‰ï¼Œæ€§èƒ½ä¼šéšç€çº¿ç¨‹æ•°é‡çš„å¢åŠ è€Œæé«˜ã€‚</li><li>å½“çº¿ç¨‹æ•°å¢åŠ åˆ°ç¼“å­˜æ— æ³•å®¹çº³æ•´ä¸ªå·¥ä½œé›†æ—¶ï¼Œæ€§èƒ½åè€Œä¼šéšç€çº¿ç¨‹æ•°é‡å¢åŠ è€Œä¸‹é™ã€‚</li><li>ä½†æ˜¯éšç€çº¿ç¨‹æ•°é‡çš„è¿›ä¸€æ­¥å¢åŠ ï¼Œæ€§èƒ½ä¼šéšç€å¤šçº¿ç¨‹éšè—ç‰‡å¤–å»¶è¿Ÿçš„èƒ½åŠ›è€Œæé«˜ã€‚<br>GPUå°±æ˜¯é€šè¿‡é‡‡ç”¨å¤šçº¿ç¨‹æ¥å®¹å¿é¢‘ç¹çš„ç¼“å­˜æœªå‘½ä¸­ï¼Œæé«˜è¿ç®—æ€§èƒ½ã€‚</li></ol><p>å†…å­˜è®¿é—®ä¸ä»…é™ä½æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿä¼šæé«˜èƒ½è€—ã€‚æ–°çš„GPGPUæ¶æ„çš„é‡ç‚¹æ˜¯æ”¹å–„å†…å­˜è®¿é—®ã€‚</p><h3 id="1-3-GPUç®€å²">1.3 GPUç®€å²</h3><h3 id="1-4-ä¹¦ç±å¤§çº²">1.4 ä¹¦ç±å¤§çº²</h3><ul><li>ç¬¬äºŒç« ï¼šç¼–ç¨‹æ¨¡å‹ã€ä»£ç å¼€å‘è¿‡ç¨‹ã€ç¼–è¯‘æµç¨‹</li><li>ç¬¬ä¸‰ç« ï¼šå•ä¸ªGPUæ ¸å¿ƒï¼ˆSMï¼‰çš„ä½“ç³»ç»“æ„</li><li>ç¬¬å››ç« ï¼šå†…å­˜ç³»ç»Ÿ</li><li>ç¬¬äº”ç« ï¼šå…¶ä»–ç ”ç©¶</li></ul><h2 id="Chapter-2ï¼šç¼–ç¨‹æ¨¡å‹">Chapter 2ï¼šç¼–ç¨‹æ¨¡å‹</h2><p>ç°ä»£GPUå¹¿æ³›é‡‡ç”¨SIMDç¡¬ä»¶æ¥åˆ©ç”¨æ•°æ®çº§å¹¶è¡Œï¼Œä½†GPUçš„è®¡ç®—APIï¼ˆå¦‚NVçš„cudaå’ŒAMDçš„openclï¼‰å¹¶ä¸å‘ç¨‹åºå‘˜æš´éœ²SIMDçš„ç¡¬ä»¶ï¼Œè€Œæ˜¯é‡‡å–ç±»ä¼¼MIMDçš„ç¼–ç¨‹æ¨¡å‹ï¼Œå…è®¸ç¨‹åºå‘˜åœ¨GPUä¸Šå¯åŠ¨å¤§é‡æ ‡é‡çº¿ç¨‹ã€‚å…¶ä¸­çš„æ¯ä¸€ä¸ªæ ‡é‡çº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç‰¹çš„æ‰§è¡Œè·¯å¾„ï¼Œå¹¶éƒ½å¯ä»¥è®¿é—®å†…å­˜ã€‚è¿è¡Œæ—¶ï¼ŒGPUä¸Šçš„çš„SIMDç¡¬ä»¶åˆ©ç”¨çº¿ç¨‹çš„è§„å¾‹æ€§å’Œç©ºé—´å±€éƒ¨æ€§ï¼ŒåŒæ­¥å¯åŠ¨è¿™äº›æ ‡é‡çº¿ç¨‹ç»„ï¼Œç§°ä¸ºSIMTï¼ˆå•æŒ‡ä»¤å¤šçº¿ç¨‹ï¼‰</p><ul><li>SIMDï¼šä¾‹å¦‚ä¸¤ä¸ªå‘é‡ï¼Œå¯¹ä¸¤ä¸ªå‘é‡çš„æ¯ä¸€ä¸ªåˆ†é‡è¿›è¡Œç›¸åŒçš„opæ“ä½œï¼Œè¾“å‡ºä¸ºä¸€ä¸ªå‘é‡ï¼ˆåœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œï¼Œå—ALUå®½åº¦é™åˆ¶ï¼‰</li><li>SIMTï¼šä¸SIMDåœ¨ä¸€ä¸ªçº¿ç¨‹å…¬ç”¨ä¸€ä¸ªALUä¸åŒï¼ŒSIMTæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å„æœ‰å„çš„ALUå’Œè‡ªå·±çš„æ•°æ®ï¼Œä½†æ‰§è¡Œçš„æŒ‡ä»¤ç›¸åŒï¼ˆä½†æ˜¯ç”±äºæ•°æ®ä¸åŒï¼Œæ‰§è¡ŒæŒ‡ä»¤æ—¶çš„æ§åˆ¶åˆ†æ”¯å¯èƒ½ä¼šä¸ä¸€æ ·ï¼‰</li></ul><h3 id="2-1-è¿è¡Œæ¨¡å‹">2.1 è¿è¡Œæ¨¡å‹</h3><p>ä¸ºGPUä¼˜åŒ–çš„ä»£ç å¾ˆå¯èƒ½åœ¨CPUæ¶æ„ä¸Šè¡¨ç°ä¸ä½³ã€‚å‡å®šä¸€ä¸ª å•ç²¾åº¦æ ‡é‡A * å‘é‡X + å‘é‡Y çš„å‡½æ•°å®ç°ï¼š</p><p>CPUå®ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">saxpy_serial</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">float</span> a, <span class="hljs-type">float</span> *x, <span class="hljs-type">float</span> *y)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)<br>        y[i] = a * x[i] + y[i];<br>&#125;<br>main()<br>&#123;<br>    <span class="hljs-type">float</span> *x, *y;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-comment">// çœç•¥*xã€*yçš„èµ‹å€¼æ“ä½œ</span><br>    saxpy_serial(n, <span class="hljs-number">2.0</span>, x, y);<br>    <span class="hljs-comment">// çœç•¥å†…å­˜é‡Šæ”¾æ“ä½œ</span><br>&#125;<br></code></pre></td></tr></table></figure><p>GPU-CUDAå®ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs C">__global__ <span class="hljs-type">void</span> <span class="hljs-title function_">saxpy</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">float</span> a, <span class="hljs-type">float</span> *x, <span class="hljs-type">float</span> *y)</span> <span class="hljs-comment">// __global__ä»£è¡¨å‡½æ•°åœ¨GPUä¸Šè¿è¡Œ</span><br>&#123;<br>   <span class="hljs-comment">// æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å„è‡ªçš„blockIdx.xã€blockDim.xã€threadIdx.x</span><br>   <span class="hljs-type">int</span> i = blockIdx.x * blockDim.x + threadIdx.x;<br>   <span class="hljs-comment">// threadIdx.xä»£è¡¨çº¿ç¨‹åœ¨çº¿ç¨‹å—ä¸­çš„xåæ ‡</span><br>   <span class="hljs-comment">// blockIdx.xä»£è¡¨çº¿ç¨‹æ‰€å±çš„çº¿ç¨‹å—åœ¨gridä¸­çš„xåæ ‡</span><br>   <span class="hljs-comment">// blockDim.xä¸€ä¸ªçº¿ç¨‹å—åœ¨xç»´åº¦çš„æœ€å¤§çº¿ç¨‹æ•°</span><br>   <span class="hljs-comment">// ä¸€èˆ¬æ¥è¯´çº¿ç¨‹åœ¨çº¿ç¨‹å—ä¸­æœ‰xyzä¸‰ä¸ªåæ ‡ï¼Œçº¿ç¨‹å—åœ¨ç½‘æ ¼ä¸­ä¹Ÿæœ‰xyzä¸‰ä¸ªåæ ‡ï¼Œè¿™é‡Œçœç•¥yï¼Œz</span><br>   <span class="hljs-keyword">if</span> (i &lt; n)<br>      y[i] = a * x[i] + y[i];<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>   <span class="hljs-comment">// ä¸€èˆ¬h_è¡¨ç¤ºcpuçš„å†…å­˜æŒ‡é’ˆï¼Œd_è¡¨ç¤ºgpuçš„å†…å­˜æŒ‡é’ˆ</span><br>   <span class="hljs-type">float</span> *h_x, *h_y;<br>   <span class="hljs-type">int</span> n;<br>   <span class="hljs-comment">// çœç•¥*h_xã€*h_yçš„èµ‹å€¼æ“ä½œ</span><br>   <span class="hljs-type">float</span> *d_x, *d_y;<br>   <span class="hljs-type">int</span> nblocks = (n + <span class="hljs-number">255</span>) / <span class="hljs-number">256</span>;<br>   <span class="hljs-comment">// è°ƒç”¨GPUé©±åŠ¨ç¨‹åºå¹¶è¦æ±‚åˆ†é…gpuå†…å­˜ï¼Œå¹¶å°†è¿™ä¸€ç‰‡å†…å­˜çš„åœ°å€èµ‹ç»™&amp;d_x</span><br>   cudaMalloc(&amp;d_x, n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>   cudaMalloc(&amp;d_y, n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>   <span class="hljs-comment">// å°†h_xæŒ‡å‘çš„å†…å®¹èµ‹å€¼ç»™d_xæŒ‡å‘çš„åŒºåŸŸ</span><br>   cudaMemcpy(d_x, h_x, n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>), cudaMemcpyHostToDevice);<br>   cudaMemcpy(d_y, h_y, n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>), cudaMemcpyHostToDevice);<br>   <span class="hljs-comment">// äº¤ç”±GPUï¼Œå¹¶å¯åŠ¨nblocksä¸ªçº¿ç¨‹å—ï¼ˆThread Blockï¼Œæˆ–CTAï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹å—256ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹å—ç»„æˆä¸€ä¸ªgridï¼Œå³æœ¬æ¬¡å†…æ ¸çš„è®¡ç®—å•å…ƒ</span><br>   saxpy&lt;&lt;&lt;nblocks, <span class="hljs-number">256</span>&gt;&gt;&gt;(n, <span class="hljs-number">2.0</span>, d_x, d_y);<br>   <span class="hljs-comment">// ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæ¯ä¸ªçº¿ç¨‹å—ä¸­ï¼Œæ¯32ä¸ªçº¿ç¨‹ä»¥é”æ­¥å½¢å¼ç»„æˆä¸€ç»„warpï¼Œwarpå¾€ä¸Šå†ç»„æˆçº¿ç¨‹å—</span><br>   <span class="hljs-comment">// ä¸€ä¸ªwarpåŒ…å«å¤šå°‘çº¿ç¨‹æ˜¯ç¡¬ä»¶æ¦‚å¿µï¼Œè€Œä¸€ä¸ªçº¿ç¨‹å—å¯ä»¥æœ‰å¤šå°‘çº¿ç¨‹åˆ™æ˜¯è½¯ä»¶æ¦‚å¿µï¼ˆå½“ç„¶å¾—æ˜¯warpçš„æ•´æ•°å€ï¼‰</span><br>   <span class="hljs-comment">// å°†è®¡ç®—ç»“æœè¿”å›ç»™CPUå†…å­˜</span><br>   cudaMemcpy(h_x, d_x, n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>), cudaMemcpyDeviceToHost);<br>   <span class="hljs-comment">// çœç•¥å†…å­˜é‡Šæ”¾æ“ä½œ</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç¡¬ä»¶ï¼šä¸€ä¸ªGPUæœ‰å¤šä¸ªSMï¼Œæ¯ä¸ªSMåŒ…å«å¤šä¸ªSPï¼ˆStream Processorï¼‰</p><p>è½¯ä»¶ï¼šä¸€ä¸ªGPUå†…æ ¸å¯¹åº”ä¸€ä¸ªgridï¼Œä¸€ä¸ªgridåŒ…å«å¤šä¸ªCTAã€‚CTAä¸­æœ‰å¤šä¸ªwarpï¼Œæ¯ä¸ªwarpåŒ…å«å›ºå®šæ•°é‡çš„çº¿ç¨‹æ•°ï¼ˆä¸SMä¸­SPæ•°é‡ç›¸åŒï¼‰ã€‚</p><p>GPUåœ¨è¿ç®—æ—¶ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªgridç‹¬å GPUï¼Œä¹Ÿå¯ä»¥å¤šä¸ªgridå¹¶è¡Œè·‘GPUï¼›SMå¯¹åº”çš„å·¥ä½œå•å…ƒæ˜¯CTAï¼Œå…¶ä¸­çš„åŸºæœ¬æ‰§è¡Œå•å…ƒæ˜¯warpï¼ˆå³æ¯ä¸ªSPå¯¹åº”ä¸€ä¸ªwarpä¸­çš„çº¿ç¨‹ï¼‰ï¼Œåœ¨æŸä¸ªwarpå—é˜»æ—¶SMå¯ä»¥åˆ‡æ¢åŒä¸€ä¸ªCTAä¸­çš„å…¶ä»–warpï¼Œä½†åªæœ‰è¯¥CTAæ‰§è¡Œå®Œï¼Œæ‰åˆ‡æ¢å…¶ä»–CTA</p><p>CTAä¸­çš„çº¿ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡æš‚å­˜å™¨å†…å­˜äº’ç›¸é€šä¿¡ï¼ˆNVç§°ä¹‹ä¸ºå…±äº«å†…å­˜ï¼‰ï¼ŒåŒæ­¥ä¹Ÿè½»æ¾ï¼ŒåŒæ—¶æ¯ä¸ªSMä¸­ä¹Ÿæœ‰ä¸€ä¸ªå…±äº«å†…å­˜ï¼Œå¯ä»¥åˆ†é…ç»™åœ¨è¯¥SMä¸Šè¿è¡Œçš„æ‰€æœ‰CTA</p><p>ä¸åŒCTAä¸­çš„çº¿ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½è®¿é—®çš„å…¨å±€åœ°å€ç©ºé—´é€šä¿¡ï¼Œä½†ä»£ä»·è¾ƒé«˜</p><h3 id="2-2-æŒ‡ä»¤æ¨¡å‹">2.2 æŒ‡ä»¤æ¨¡å‹</h3><p>NVçš„å¹¶è¡Œçº¿ç¨‹æ‰§è¡ŒISAï¼šParallel Thread eXecutionï¼Œç®€ç§°PTX ï¼ˆè™šæ‹ŸæŒ‡ä»¤ï¼Œç±»ä¼¼æ±‡ç¼–æŒ‡ä»¤ï¼‰</p><p>GPUè¿è¡ŒPTXä»£ç å‰ï¼Œéœ€è¦ç¼–è¯‘ï¼ˆæ±‡ç¼–ï¼‰æˆå®é™…çš„æœºå™¨æŒ‡ä»¤ï¼ŒNVç§°æ­¤ä¸ºSASSï¼ˆStreaming ASSemblerï¼‰ï¼Œè¯¥è¿‡ç¨‹æœ‰NVçš„å·¥å…·åŒ…å®Œæˆï¼Œå¹¶æ²¡æœ‰å¼€æ”¾ï¼Œè¿™ä½¿å¾—NVå¯ä»¥åœ¨ç¡¬ä»¶çº§åˆ«æä¾›å‘åå…¼å®¹æ€§ï¼Œæ¯ä¸€ä»£éƒ½å¯ä»¥é‡æ–°è®¾è®¡ISAæ¶æ„</p><h2 id="Chapter-3ï¼šSIMTæ ¸å¿ƒï¼šæŒ‡ä»¤å’Œå¯„å­˜å™¨æ•°æ®æµ">Chapter 3ï¼šSIMTæ ¸å¿ƒï¼šæŒ‡ä»¤å’Œå¯„å­˜å™¨æ•°æ®æµ</h2><p>å¯¹ä¼ ç»Ÿå›¾å½¢æ¸²æŸ“æ¥è¯´ï¼ŒGPUé€šå¸¸éœ€è¦è®¿é—®è¯¦ç»†çš„çº¹ç†å›¾ï¼Œè¿™æ ·çš„æ•°æ®é›†å› ä¸ºå¤ªå¤§ä¸å¯èƒ½å®Œå…¨ç¼“å­˜åœ¨èŠ¯ç‰‡ä¸Šï¼Œå› æ­¤æœ‰å¿…è¦é‡‡ç”¨èƒ½å¤Ÿç»´æŒå¤§ç‰‡å¤–å¸¦å®½çš„GPUæ¶æ„ã€‚æ‰€ä»¥å¦‚ä»Šçš„GPUéƒ½å¾€é«˜å¹¶å‘çº¿ç¨‹å‘å±•ï¼ˆå¤§æ¦‚æ„æ€æ˜¯çº¿ç¨‹è¶Šå¤šè¶Šèƒ½å¤Ÿéšè—è®¿å­˜æŸå¤±ï¼‰ã€‚å¹¶ä¸”ï¼Œå°½ç®¡æ¯ä¸ªçº¿ç¨‹çš„ç‰‡ä¸Šç¼“å­˜å¾ˆå°ï¼Œä½†å› ä¸ºå±€éƒ¨æ€§åŸç†ï¼Œä»ç„¶å¯ä»¥æœ‰æ•ˆå‡å°‘å¤§é‡çš„ç‰‡å¤–å­˜å‚¨è®¿é—®ã€‚</p><p>SMçš„å¾®ä½“ç³»ç»“æ„ï¼Œæµæ°´çº¿åˆ†ä¸ºSIMTå‰ç«¯å’ŒSIMDåç«¯ï¼Œå…±3ä¸ªå¾ªç¯ï¼š</p><ol><li>å–å€¼ï¼ˆfetchï¼‰å¾ªç¯ï¼šfetchã€I-Cacheã€Decodeå’ŒI-Bufferæ¨¡å—</li><li>å‘æŒ‡ï¼ˆissueï¼‰å¾ªç¯ï¼šI-Bufferã€Scoreboardã€issueå’ŒSIMT stackæ¨¡å—</li><li>å¯„å­˜å™¨è®¿é—®è°ƒåº¦å¾ªç¯ï¼šOperand Collectorã€ALUå’ŒMemoryæ¨¡å—</li></ol><p><img src="image.png" alt=" "></p><h3 id="3-1-å•å¾ªç¯è¿‘ä¼¼">3.1 å•å¾ªç¯è¿‘ä¼¼</h3><p>çº¿ç¨‹çš„è°ƒåº¦å•ä½æ˜¯warpï¼ˆAMDç§°ä¹‹ä¸ºwavefrontsï¼‰ã€‚æ¯ä¸€ä¸ªå‘¨æœŸï¼ŒSMé€‰æ‹©ä¸€ä¸ªwarpè¿›è¡Œè°ƒåº¦ã€‚</p><p>å•å¾ªç¯ä¸­ï¼Œwarpçš„ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ç”¨äºè®¿é—®æŒ‡ä»¤å­˜å‚¨å™¨æ—¶æŸ¥æ‰¾ä¸ºwarpæ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚è·å¾—æŒ‡ä»¤åï¼Œå¯¹æŒ‡ä»¤è§£ç ï¼Œå¹¶æ‰¾åˆ°æºæ“ä½œæ•°å¯„å­˜å™¨ã€‚ä¸æ­¤åŒæ—¶ï¼ŒSIMTçš„æ‰§è¡Œæ©ç å€¼ä¹Ÿè¢«ç¡®å®šã€‚</p><p>åœ¨æ‰§è¡Œæ©ç ä¸æºå¯„å­˜å™¨å¯ç”¨åï¼Œæ‰§è¡Œä»¥SIMDçš„æ–¹å¼è¿›è¡Œã€‚å¦‚æœè®¾ç½®äº†SIMTæ‰§è¡Œæ©ç ï¼Œåˆ™æ¯ä¸ªçº¿ç¨‹éƒ½åœ¨ä¸é€šè·¯å…³è”çš„åŠŸèƒ½å•å…ƒä¸Šæ‰§è¡Œã€‚ä¸ç°ä»£CPUä¸€æ ·ï¼ŒåŠŸèƒ½å•å…ƒé€šå¸¸å¼‚æ„ï¼Œå³ä¸åŒçš„å•å…ƒæ”¯æŒä¸åŒçš„æŒ‡ä»¤è¿è¡Œã€‚</p><p>æ¯ä¸ªåŠŸèƒ½å•å…ƒåœ¨åä¹‰ä¸ŠåŒ…å«çš„é€šè·¯æ•°ä¸warpçš„çº¿ç¨‹æ•°ç›¸åŒï¼Œä½†ä¹Ÿæœ‰ä¸€äº›GPUä½¿ç”¨ä¸åŒçš„å®ç°ï¼Œä½¿å…¶ä¸­çš„warpåœ¨å¤šä¸ªæ—¶é’Ÿå‘¨æœŸå†…æ‰§è¡Œã€‚</p><h4 id="3-1-1-SIMTæ‰§è¡Œæ©ç ">3.1.1 SIMTæ‰§è¡Œæ©ç </h4><p>ç°ä»£GPUçš„å…³é”®ç‰¹æ€§æ˜¯SIMTæ‰§è¡Œæ¨¡å‹ï¼Œä¸ºç¨‹åºå‘˜æä¾›äº†å•ä¸ªçº¿ç¨‹å®Œå…¨ç‹¬ç«‹æ‰§è¡Œçš„æŠ½è±¡ï¼Œè¿™æ˜¯é€šè¿‡ä¼ ç»Ÿè°“è¯ï¼ˆpredictionï¼‰ä¸SIMTè°“è¯æ©ç å †æ ˆç»“åˆå®ç°çš„ã€‚</p><p>SIMTå †æ ˆæœ‰åŠ©äºå¤„ç†çº¿ç¨‹å¯ä»¥ç‹¬ç«‹æ‰§è¡Œæ—¶å‡ºç°çš„ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š</p><ol><li>åµŒå¥—æ§åˆ¶æµ</li><li>å®Œå…¨è·³è¿‡è®¡ç®—</li></ol><table><thead><tr><th style="text-align:center"><img src="image-1.png" alt=" "></th><th style="text-align:center"><img src="image-2.png" alt=" "></th><th style="text-align:center"><img src="image-3.png" alt=" "></th></tr></thead></table><p>å‡è®¾æ¯ä¸ªwarpæœ‰å››ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½æ‰§è¡Œäº†AåŸºæœ¬å—ï¼Œä¹‹åéµå¾ªä¸åŒçš„æ§åˆ¶æµï¼Œæœ‰3ä¸ªçº¿ç¨‹è¿›å…¥Bï¼Œ1ä¸ªçº¿ç¨‹è¿›å…¥Fã€‚å¦‚æ­¤æµåŠ¨ï¼Œæœ€åæ‰€æœ‰çº¿ç¨‹ç»Ÿä¸€åˆ°è¾¾Gã€‚</p><table><thead><tr><th style="text-align:center"><img src="image-4.png" alt=" "></th><th style="text-align:center"><img src="image-5.png" alt=" "></th></tr></thead></table><p>å †æ ˆåŒ…æ‹¬ä¸‰é¡¹ï¼šé‡æ–°æ”¶æ•›ç¨‹åºè®¡æ•°å™¨(Reconvergence program counter, RPC)ã€è¦æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€(Next PC)å’Œæ´»è·ƒæ©ç (active mask)ã€‚warpæ¯æ¬¡éƒ½æ‰§è¡Œæ ˆé¡¶æŒ‡é’ˆæŒ‡å‘çš„æ¡ç›®çš„nextPCæŒ‡å‘çš„ä»£ç å—</p><ol><li>å¼€å§‹æ—¶å †æ ˆä¸­åªæœ‰ä¸€ä¸ªæ¡ç›®â€œ-ï¼ŒAï¼Œ1111â€ã€‚ä»£è¡¨æ‰€æœ‰çº¿ç¨‹éƒ½å°†è¿›å…¥Aã€‚</li><li>æ‰€æœ‰4ä¸ªçº¿ç¨‹åœ¨èµ°å®ŒAä¹‹åè¿›è¡Œåˆ†æ”¯ï¼Œæ­¤æ—¶éœ€è¦æœ‰3å¤„ä¿®æ”¹ï¼š<ul><li>å°†åŸå…ˆæ¡ç›®çš„nextPCå€¼ä¿®æ”¹æˆåˆ†æ”¯åçš„é‡æ–°æ±‡èšç‚¹ï¼Œå¯¹äºè¿™æ¬¡åˆ†æ”¯Bå’ŒFï¼Œå°†åœ¨Gé‡æ–°æ±‡èšï¼Œå› æ­¤å°†ç¬¬ä¸€æ¡çš„nextPCç”±Aä¿®æ”¹ä¸ºG</li><li>è¿™æ¬¡åˆ†æ”¯æœ‰3ä¸ªè¿›å…¥Bï¼Œ1ä¸ªè¿›å…¥Fï¼Œå› æ­¤åœ¨å †æ ˆä¸­å‹å…¥å…³äºBå’ŒFçš„ä¸¤ä¸ªæ¡ç›®</li></ul></li><li>çº¿ç¨‹æ‰§è¡Œæ ˆé¡¶æ¡ç›®â€œGï¼ŒBï¼Œ1110â€ï¼Œæ©ç æ˜¯1110ä»£è¡¨è¿™è¡Œæ¡ç›®å¯¹å‰ä¸‰ä¸ªçº¿ç¨‹activeï¼Œèµ°å®ŒBåè¿›è¡Œåˆ†æ”¯ï¼ŒåŒç†ä¿®æ”¹åŸæ¥æ¡ç›®çš„nextPCï¼Œæ”¹æˆæœ€è¿‘çš„é‡æ–°æ”¶æ•›ç‚¹Eï¼ŒåŒæ—¶æ·»åŠ ä¸¤ä¸ªåˆ†æ”¯æ¡ç›®ã€‚<ul><li>ä¸€èˆ¬æ”¹æˆæœ€è¿‘çš„é‡æ–°æ”¶æ•›ç‚¹ï¼Œæ˜¯ä¸ºäº†ä»è¯¥ä½ç½®å°†ä¹‹å‰å‘æ•£çš„çº¿ç¨‹ä»¥é”æ­¥çš„æ–¹å¼ç»§ç»­æ‰§è¡Œï¼Œä¾¿äºåŒæ­¥</li><li>é€šå¸¸æ¥è¯´ï¼Œåœ¨åˆ†æ”¯è¿‡åï¼Œæœ€å¥½æ˜¯å…ˆå°†æœ€å¤šæ´»è·ƒçº¿ç¨‹çš„æ¡ç›®å…ˆå…¥æ ˆï¼Œå°‘æ´»è·ƒçº¿ç¨‹çš„æ¡ç›®åå…¥æ ˆï¼Œä¾‹å¦‚déƒ¨åˆ†ï¼Œè€Œcéƒ¨åˆ†çš„ä¾‹å­ç›¸å</li></ul></li></ol><h4 id="3-1-2-SIMTæ­»é”ä¸æ— å †æ ˆSIMTç»“æ„">3.1.2 SIMTæ­»é”ä¸æ— å †æ ˆSIMTç»“æ„</h4><p>SIMTåŸºäºå †æ ˆçš„å®ç°å¯èƒ½å¯¼è‡´æ­»é”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// å°†mutexç½®0ä»£è¡¨èµ„æºç©ºé—²</span><br>*mutex = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// atomicCASè¯»å–mutexï¼Œè‹¥ä¸º0ï¼Œåˆ™ç½®1ï¼ˆå³è‹¥ç©ºé—²ï¼Œåˆ™è®¿é—®ï¼‰ï¼Œè¿”å›mutexåŸå§‹å€¼</span><br><span class="hljs-comment">// ä¸€ä¸ªwarpä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½æ‰§è¡Œï¼Œå› æ­¤åªæœ‰ä¸€ä¸ªçº¿ç¨‹çœ‹åˆ°mutex=0ï¼Œå…¶ä»–éƒ½çœ‹åˆ°=1</span><br><span class="hljs-keyword">while</span>(!atomicCAS(mutex,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>));<br><span class="hljs-comment">// é‡Šæ”¾mutex</span><br>atomicExch(mutex,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>ç®€è€Œè¨€ä¹‹ï¼Œå¯¹äºä¸€ä¸ªäº’æ–¥èµ„æºï¼Œå½“ä¸€ä¸ªwarpçš„æ‰€æœ‰çº¿ç¨‹åŒæ—¶æ‰§è¡Œäº’æ–¥é”å¼è®¿é—®æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°èµ„æºï¼Œå…¶ä»–çº¿ç¨‹é™·å…¥åŸåœ°ç­‰å¾…ã€‚ä½†æ˜¯ï¼Œæ‹¿åˆ°èµ„æºçš„çº¿ç¨‹åœ¨æ‰§è¡Œå®Œæ¯•åï¼Œè¾¾åˆ°äº†ä¸Šæ–‡ä¸­çš„é‡æ–°æ”¶æ•›ç‚¹ï¼Œä¼šç­‰å¾…å…¶ä»–æ‰€æœ‰çº¿ç¨‹ä¸€èµ·åˆ°è¿™ä¸ªç‚¹ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œç¬¬ä¸‰å¥é‡Šæ”¾é”ã€‚</p><p>æ— å †æ ˆåˆ†æ”¯çš„é‡æ–°æ”¶æ•›æœºåˆ¶ï¼šwarpæ”¶æ•›å±éšœ</p>]]></content>
    
    
    <categories>
      
      <category>work</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®ºæ–‡ç¬”è®°</tag>
      
      <tag>TBC</tag>
      
      <tag>GPGPA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DianNaoç³»åˆ—è®ºæ–‡é˜…è¯»</title>
    <link href="/2023/09/14/DianNao%E7%B3%BB%E5%88%97%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/"/>
    <url>/2023/09/14/DianNao%E7%B3%BB%E5%88%97%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="DianNao-A-Small-Footprint-High-Throughput-Accelerator-for-Ubiquitous-Machine-Learning">DianNao: A Small-Footprint High-Throughput Accelerator for Ubiquitous Machine-Learning</h2><h3 id="æ¦‚è¿°">æ¦‚è¿°</h3><p>DianNaoï¼šä¸€ä¸ªç”¨äºæ™®éæœºå™¨å­¦ä¹ çš„å°è§„æ¨¡é«˜é€šé‡åŠ é€Ÿå™¨ã€‚å¯’æ­¦çºªå¼€å±±ä¹‹ä½œ</p><p>ç°é˜¶æ®µï¼ˆ2014ï¼‰æœºå™¨å­¦ä¹ å·¥ä½œä¸­ï¼ˆCNNã€ç¥ç»ç½‘ç»œï¼‰CPUæ€§èƒ½ä¸å¤Ÿï¼ŒGPUã€FPGAç­‰åŠŸè€—è¿‡é«˜ã€‚</p><p>å½“å‰çš„ç»å¤§å¤šæ•°accçš„å…³æ³¨ç‚¹éƒ½åœ¨äºç®—æ³•è®¡ç®—éƒ¨åˆ†ï¼ˆefficiently implementing the computational part of the algorithmsï¼‰ï¼Œç„¶è€ŒCNNå’ŒDNNçš„ç‰¹ç‚¹æ˜¯å¤§å°ºå¯¸ã€å¤§è®¡ç®—é‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDMAçš„æ•ˆæœä¸å¤ªå¥½ã€‚å› æ­¤æˆ‘ä»¬é’ˆå¯¹è¿™ä¸€ç‰¹æ€§ï¼Œè®¾è®¡äº†ä¸€ä¸ªä¸“é—¨å¯¹è®¿å­˜åšç‰¹åˆ«ä¼˜åŒ–çš„åŠ é€Ÿå™¨</p><p>å¯¹æ¯”å¸¸è§„SIMDå¤„ç†å™¨é€Ÿåº¦å¿«117å€ï¼Œèƒ½è€—æ¯”æé«˜21å€</p><h3 id="Intro">Intro</h3><p>åŠ é€Ÿå™¨è®¾è®¡çš„æƒè¡¡ï¼šçµæ´»æ€§å’Œé«˜æ€§èƒ½ã€‚è€Œç”±äºå½“æ—¶æœºå™¨å­¦ä¹ çš„SOTAå°±æ˜¯CNNå’ŒDNNï¼Œç§ç±»æœ‰é™ï¼Œæ‰€ä»¥å¯ä»¥è¿™ç±»è®¡ç®—è®¾è®¡å‡ºæœ‰é’ˆå¯¹æ€§çš„åŠ é€Ÿå™¨</p><p>å½“å‰é’ˆå¯¹CNNæˆ–MLPçš„åŠ é€Ÿå™¨éƒ½ä¸“æ³¨äºç¥ç»ç½‘ç»œä¸­è®¡ç®—åŸè¯­å¦‚å·ç§¯çš„æœ‰æ•ˆå®ç°ï¼Œå¦‚çŸ©é˜µä¹˜æ³•ã€å‘é‡è®¡ç®—æ–¹é¢çš„ä¼˜åŒ–ã€‚ä½†æ˜¯å¿½ç•¥äº†å¯¹æ€§èƒ½å½±å“åŒæ ·å·¨å¤§çš„è®¿å­˜éƒ¨åˆ†</p><p>ç”±äºé˜¿å§†è¾¾å°”å®šå¾‹ï¼Œå³ä½¿è®¡ç®—åŸä»¶åšå¤§é‡ä¼˜åŒ–ï¼Œæ•´ä½“æ€§èƒ½ä¾æ—§ä¼šå—åˆ¶äºå†…å­˜ä¼ è¾“éƒ¨åˆ†ï¼Œå¹¶ä¸”åœ¨æœºå™¨å­¦ä¹ é¢†åŸŸï¼Œä¸ºäº†å®ç°æ›´é«˜çš„ç²¾åº¦å’ŒåŠŸèƒ½ï¼Œæœ‰ä¸€ä¸ªå¿…ç„¶çš„è¶‹åŠ¿å°±æ˜¯æé«˜ç¥ç»ç½‘ç»œçš„è§„æ¨¡ï¼Œè€Œè¿™ä¹Ÿè¯æ˜äº†è®¿å­˜ä¼˜åŒ–å¯¹äºè®¾è®¡åŠ é€Ÿå¡çš„é‡è¦æ€§</p><p>ä¸»è¦è´¡çŒ®ï¼šé«˜ååã€é«˜èƒ½è€—æ¯”ã€ä¾§é‡å†…å­˜æ€§èƒ½çš„åŠ é€Ÿå¡è®¾è®¡</p><h3 id="æœ€æ–°æœºå™¨å­¦ä¹ æŠ€æœ¯å…¥é—¨">æœ€æ–°æœºå™¨å­¦ä¹ æŠ€æœ¯å…¥é—¨</h3><p>å½“å‰çš„å¸‚åœºæ¥è¯´ï¼Œæˆ‘ä»¬çš„åŠ é€Ÿå™¨åº”è¯¥èšç„¦äºç½‘ç»œçš„å‰é¦ˆè€Œéåé¦ˆã€‚è¿™æ˜¯ç”±äºåœ¨è®¸å¤šä¸šåŠ¡åœºæ™¯ä¸‹ç¦»çº¿å­¦ä¹ éƒ½æ˜¯ä¸»æµï¼Œç½‘è·¯å¯ä»¥å‘¨æœŸæ€§çš„è¿›è¡Œç¦»çº¿å­¦ä¹ ï¼Œè€Œæ‹¿åˆ°å®¢æˆ·æ‰‹ä¸­åªéœ€è¦é«˜æ•ˆçš„å‰å‘æ¨ç†ã€‚å¹¶ä¸”ç”±äºåå‘ä¼ æ’­å’Œæ­£å‘è·¯å¾„åŸç†ç±»ä¼¼ï¼Œæˆ‘ä»¬åœ¨ä¹‹åä¹Ÿä¼šé’ˆå¯¹åå‘ä¼ æ’­åšå‡ºä¼˜åŒ–å·¥ä½œ</p><h3 id="åŸºäºå¤„ç†å™¨çš„ï¼ˆå¤§å‹ï¼‰ç¥ç»ç½‘ç»œå®ç°">åŸºäºå¤„ç†å™¨çš„ï¼ˆå¤§å‹ï¼‰ç¥ç»ç½‘ç»œå®ç°</h3><table><thead><tr><th style="text-align:center"><img src="image.png" alt=" "></th><th style="text-align:center"><img src="image-1.png" alt=" "></th><th style="text-align:center"><img src="image-2.png" alt=" "></th></tr></thead></table><ol><li><p>classifierå±‚</p><ul><li>å°±æ˜¯å…¨è¿æ¥å±‚ï¼Œåœ¨ä¸€èˆ¬çš„ç†è§£ä¸­ï¼Œæ¯ä¸€ä¸ªoutputç›¸å½“äºæ‰€æœ‰inputçš„åŠ æƒæ±‚å’Œåœ¨Sigmoidå‡ºçš„æ¦‚ç‡å€¼ï¼Œå¦‚å›¾æ‰€ç¤ºï¼ŒsynapsesçŸ©é˜µå¯¹äºæ¯ä¸ªoutputæ¥è¯´è¯¥inputçš„æƒé‡</li><li>é¦–å…ˆå±•ç¤ºçš„æ˜¯é’ˆå¯¹å…¨è¿æ¥å±‚çš„ä¼˜åŒ–ï¼Œä¸€èˆ¬æ¯”è¾ƒç¬¦åˆç›´è§‚æ€ç»´çš„æ¨¡å¼æ˜¯é€è¡Œè¿ç®—ï¼Œæ¯æ¬¡è¾“å‡ºä¸€ä¸ªoutputã€‚è¿™ç§æ–¹å¼åœ¨é‡åˆ°å¤§è§„æ¨¡ç¥ç»ç½‘ç»œï¼ˆi/oç¥ç»å…ƒæ•°é‡å¤§ï¼‰æ—¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¯¹å¸¦å®½è¦æ±‚é«˜ï¼Œå†…å­˜è¿è¾“æ€»æ•°= inputs loaded + synapses loaded + outputs written = Ni x Nn + Ni x Nn + Nn</li><li>æ”¹è¿›æ–¹å¼ï¼šå°†è¾“å…¥ç¥ç»å…ƒè¿›è¡Œtile loopï¼Œåœ¨L1ç¼“å­˜ä¸å¤Ÿå¤§çš„æƒ…å†µä¸‹ï¼Œå¹³é“ºå†åˆ†å—ï¼Œç±»ä¼¼å·ç§¯å±‚ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯¹inputç¥ç»å…ƒçš„æ•°æ®åšäº†å¤ç”¨ï¼Œå¤§å¤§é™ä½äº†è¾“å…¥ç¥ç»å…ƒçš„å†…å­˜å¸¦å®½éœ€æ±‚ï¼Œç•¥å¾®å¢åŠ äº†è¾“å‡ºå¸¦å®½éœ€æ±‚ï¼ˆå› ä¸ºä¸å†æ˜¯ä¸€æ¬¡å‡ºç»“æœï¼Œéœ€è¦writtenå¤šæ¬¡ï¼‰</li><li>åŒæ—¶å¦‚æœå°†synapsesçŸ©é˜µå­˜å…¥L2ç¼“å­˜ï¼ˆå¯¹äºå½“æ—¶çš„ç¥ç»ç½‘ç»œæ¥è¯´ï¼Œæƒé‡æ€»æ•°åœ¨ç™¾ä¸‡æ•°é‡çº§ï¼Œä»åœ¨L2çš„èŒƒå›´å†…ï¼‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥å‡å°‘æ‰€éœ€å¸¦å®½</li></ul></li><li><p>å·ç§¯å±‚</p><ul><li>æœ‰ä¸¤ç§æ•°æ®å¤ç”¨å¯èƒ½ï¼šæ»‘åŠ¨çª—å£ï¼ˆå°±æ˜¯å·ç§¯æ ¸æƒé‡ï¼Œæ»‘åŠ¨è¿‡ç¨‹ä¸­å·ç§¯æ ¸ä¸å˜ï¼‰ä»¥åŠè·¨é€šé“çš„è¾“å‡ºå¤ç”¨</li><li>ç®€å•æ¥è¯´å°±æ˜¯æ¯æ¬¡ä¸å†éƒ½æ•´ä¸ªinput feature mapï¼Œè€Œæ˜¯åœ¨mapä¸Šæˆªå–ä¸€ç‰‡Tx*Tyï¼Œæ¯æ¬¡ä¸åŒçš„å·ç§¯æ ¸åœ¨ä¸Šé¢å·ç§¯è¿ç®—ä¹‹åé€ç»™outputï¼Œå†æœ€ååŠ æƒæ±‚å’Œ</li><li>æ— éæ˜¯ç”±äºç¼“å­˜ç©ºé—´é™åˆ¶è€Œå¯¹feture mapsã€Input channelã€output channelåšå‡ºæˆªå–ï¼Œè®©è¿ç®—æ—¶æ•°æ®éƒ½åœ¨ç¼“å­˜ä¸­ï¼Œé™ä½å†…å­˜å¸¦å®½</li><li>é’ˆå¯¹å·ç§¯æ ¸æƒå€¼å…±äº«åšäº†ä¼˜åŒ–ï¼Œæ–‡ç« å€¾å‘äºå…±äº«å·ç§¯æ ¸</li></ul></li><li><p>æ± åŒ–å±‚:</p><ul><li>é‡ç”¨æœºä¼šå°‘ï¼Œå¯¹äºå¢åŠ Txï¼ŒTyæ•ˆæœä¸æ˜¾è‘—</li></ul></li></ol><h3 id="å°å‹ç¥ç»ç½‘ç»œåŠ é€Ÿå™¨">å°å‹ç¥ç»ç½‘ç»œåŠ é€Ÿå™¨</h3><ul><li>å¯¹äºå°å‹ç½‘ç»œï¼Œå¯å‡è®¾æ‰€æœ‰ç¥ç»å…ƒå’Œçªè§¦éƒ½ç”±ç¡¬ä»¶å®ç°ï¼Œå†…å­˜ä»…ç”¨äºI/O</li><li>å¯¹äºå°å‹ç¥ç»ç½‘ç»œå¯ä»¥å¤§å¹…æé«˜èƒ½è€—ï¼Œä½†éšç¥ç»å…ƒæ•°é‡å¢å¤šé¢ç§¯ã€èƒ½é‡å’Œå»¶è¿Ÿå‘ˆäºŒæ¬¡æ–¹å¢é•¿</li></ul><h3 id="å¤§å‹ç¥ç»ç½‘ç»œåŠ é€Ÿå™¨">å¤§å‹ç¥ç»ç½‘ç»œåŠ é€Ÿå™¨</h3><p><img src="image-3.png" alt=" "></p><p>æ€»å…±ä¸‰å¤§éƒ¨ä»¶ï¼š</p><ul><li>è¿ç®—éƒ¨åˆ†ï¼šNFU</li><li>å­˜å‚¨éƒ¨åˆ†ï¼šè¾“å…¥ç¼“å­˜NBinã€è¾“å‡ºç¼“å­˜NBoutã€çªè§¦æƒé‡SB</li><li>æ§åˆ¶é€»è¾‘ï¼šCP</li></ul><p>NFUï¼š</p><ul><li>æŒ‰ç…§ç¬¬ä¸‰èŠ‚ï¼Œå°†æ¯ä¸€å±‚åˆ†è§£ä¸ºTiå’ŒTnçš„è®¡ç®—å—</li><li>æµæ°´çº¿ï¼šlayeréƒ½å¯ä»¥åˆ†ä¸ºè‹¥å¹²ä¸ªè§„èŒƒè®¡ç®—å•å…ƒçš„ç»„åˆï¼Œå°†æ•´ä¸ªè®¡ç®—è§„èŒƒåŒ–ï¼Œæµç¨‹åŒ–<ol><li>NFU-1ï¼šä¹˜æ³•å•å…ƒ</li><li>NFU-2ï¼šåŠ æ³•æ ‘</li><li>NFU-3ï¼šæ¿€æ´»å•å…ƒ</li></ol></li></ul><p>å…¨è¿æ¥å±‚ï¼šçªå‡º*è¾“å…¥ï¼›ä¹˜ç§¯æ±‚å’Œï¼›æ¿€æ´»å‡½æ•°sigmoidï¼›<br>å·ç§¯å±‚ï¼šè®¡ç®—é˜¶æ®µç›¸åŒï¼Œåªæ˜¯æ¿€æ´»å‡½æ•°å¯èƒ½ä¸åŒï¼›<br>æ± åŒ–å±‚ï¼šæ²¡æœ‰ä¹˜ç§¯çš„æ“ä½œï¼Œå¯ä»¥æ˜¯æ±‚æœ€å¤§æ± åŒ–å’Œå¹³å‡æ± åŒ–</p><h2 id="DaDianNao-A-Machine-Learning-Supercomputer">DaDianNao: A Machine-Learning Supercomputer</h2><h3 id="æ¦‚è¿°-2">æ¦‚è¿°</h3><p>åœ¨å¤šæ ¸èŠ¯ç‰‡ä¸­ï¼Œç”±äºCNNså’ŒDNNsæ‰€éœ€å†…å­˜å¹¶æœªè¶…è¿‡å…¶ç‰‡ä¸Šå­˜å‚¨ç©ºé—´ï¼Œç»“åˆCNN/DNNç®—æ³•è‡ªèº«ç‰¹ç‚¹ï¼Œä¼šå¯¼è‡´é«˜å†…éƒ¨å¸¦å®½å’Œä½å¤–éƒ¨é€šä¿¡è¿™ä¸€æƒ…å†µï¼Œä»è€Œèƒ½åœ¨åˆç†çš„åŒºåŸŸæˆæœ¬ä¸‹å®ç°é«˜å¹¶å‘ã€‚</p><h3 id="Intro-2">Intro</h3><p>å‰äººå·¥ä½œç¼ºé™·ï¼šåŠ é€ŸèŠ¯ç‰‡è¦ä¹ˆæœ‰ç¥ç»ç½‘ç»œå¤§å°é™åˆ¶ï¼Œè¦ä¹ˆå¯¹äºå¤§å‹ç½‘ç»œï¼Œç¥ç»å…ƒå’Œçªè§¦å¿…é¡»å­˜å‚¨åœ¨å†…å­˜ä¸­</p><p>ç¥ç»ç½‘ç»œæ€§èƒ½ç“¶é¢ˆï¼šå†…å­˜è®¿é—®</p><h3 id="The-GPU-Option-The-Accelerator-Option">The GPU Option/ The Accelerator Option</h3><p>CPUä¸GPUä¸DianNaoçš„ä¸€äº›æ¯”è¾ƒï¼›DianNaoçš„ä»‹ç»ï¼Œç°æœ‰DianNaoçš„ä¸è¶³</p><p>ä¸»è¦çš„é™åˆ¶æ¥æºäºä¸¤ç§é‡è¦å±‚çš„å†…å­˜å¸¦å®½éœ€æ±‚ï¼šç§æœ‰å†…æ ¸çš„å·ç§¯å±‚(ç”¨äºdnn)å’Œå…¨è¿æ¥å±‚</p><h3 id="A-Machine-Learning-Supercomputer">A Machine-Learning Supercomputer</h3><p>æƒé‡å­˜å‚¨åœ¨å°†ä½¿ç”¨å®ƒä»¬çš„ç¥ç»å…ƒé™„è¿‘ï¼Œæœ€å¤§é™åº¦åœ°é™ä½æ•°æ®ç§»åŠ¨ï¼ŒèŠ‚çœæ—¶é—´å’Œèƒ½é‡;æ¶æ„æ˜¯å®Œå…¨åˆ†å¸ƒå¼çš„ï¼Œæ²¡æœ‰ä¸»å­˜</p><p>éå¯¹ç§°çš„ä½“ç³»ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹å ç”¨çš„ç©ºé—´å¤§é‡åå‘äºå­˜å‚¨è€Œä¸æ˜¯è®¡ç®—</p><p>ä¼ é€’ç¥ç»å…ƒå€¼è€Œä¸æ˜¯æƒé‡ï¼Œå› ä¸ºåœ¨ä¸¤ä¸ªå…¸å‹å±‚ä¸­ï¼Œç¥ç»å…ƒå€¼æ¯”æƒé‡æ•°é‡çº§å°ï¼Œéœ€è¦ç›¸å¯¹è¾ƒå°‘çš„å¤–éƒ¨(è·¨èŠ¯ç‰‡)å¸¦å®½</p><p>é€šè¿‡å°†æœ¬åœ°å­˜å‚¨åˆ†è§£æˆè®¸å¤šå—æ¥å®ç°é«˜çš„å†…éƒ¨å¸¦å®½</p><p>å°†SRAMæ›´æ¢ä¸ºeDRAMï¼Œç¼©å°é¢ç§¯ï¼Œä½†éœ€è¦å‘¨æœŸæ€§åˆ·æ–°ã€å»¶è¿Ÿé«˜</p><p>NFUæ— æ³•ç®€å•æ‰©å¤§è§„æ¨¡ï¼šæ•°æ®å¸ƒçº¿é¢ç§¯å ç”¨è¿‡å¤šï¼Œå¯æ‰©å±•æ€§å·®</p><p>å¯¹NFUè¿›è¡Œåˆ†ç‰‡</p><h2 id="Cambricon-An-Instruction-Set-Architecture-for-Neural-Networks">Cambricon: An Instruction Set Architecture for Neural Networks</h2><h3 id="æ¦‚è¿°-3">æ¦‚è¿°</h3><p>ä¼ ç»Ÿç¥ç»ç½‘ç»œå¾€å¾€åœ¨CPUã€GPGPUè¿™æ ·çš„çš„é€šç”¨å¹³å°æ‰§è¡Œï¼Œé€šå¸¸æ¥è¯´ä¸å¤ŸèŠ‚èƒ½ï¼Œå› ä¸ºè¿™ç§å¹³å°ä¸»è¦æ˜¯ä¸ºäº†çµæ´»æ”¯æŒå„ç±»å‹å·¥ä½œ</p><p>æœ€è¿‘çš„ä¸€äº›ç¡¬ä»¶åŠ é€Ÿå™¨ï¼Œè¿™ç±»åŠ é€Ÿå™¨é€šå¸¸é‡‡ç”¨é«˜çº§æŒ‡ä»¤ç›´æ¥æ§åˆ¶é«˜çº§åŠŸèƒ½å—ã€‚ä½†æ˜¯ï¼Œå½“éœ€è¦çµæ´»æ”¯æŒå„ç§ä¸åŒçš„NNæ—¶ï¼Œè¿™ç§ç›´æ¥æ§åˆ¶å—çš„æ–¹å¼å°±ä¸å¤ªè¡Œ</p><p>æ€è·¯ a. åˆ†è§£å¤§å—çš„æ“ä½œæˆä¸€ä¸ªä¸ªå°çš„æŒ‡ä»¤ï¼Œè·å¾—æ›´å¤§çš„çµæ´»æ€§ã€‚ç”¨æˆ·å¯ä»¥ç”¨ä½å±‚æ¬¡çš„æ“ä½œç»„åˆæˆé«˜å±‚æ¬¡çš„åŠŸèƒ½ã€‚b. ç®€å•çš„çŸ­æŒ‡ä»¤å¯ä»¥å¤§å¹…é™ä½è®¾è®¡éªŒè¯çš„å¤æŸ¥åº¦å’Œè§£ç å™¨çš„åŠŸè€—å’Œé¢ç§¯ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>work</category>
      
    </categories>
    
    
    <tags>
      
      <tag>DianNao</tag>
      
      <tag>è®ºæ–‡ç¬”è®°</tag>
      
      <tag>TBC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>00ï¼šä¸ªäººç½‘ç«™éƒ¨ç½²</title>
    <link href="/2023/09/13/00%EF%BC%9A%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99%E9%83%A8%E7%BD%B2/"/>
    <url>/2023/09/13/00%EF%BC%9A%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<p>èŠ±äº†ä¸¤ä¸‰å¤©æ—¶é—´æ­äº†ä¸€ä¸ªç”¨äºç¬”è®°çš„ä¸ªäººåšå®¢ï¼Œéƒ¨ç½²åœ¨äº† github ä¸Šï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹éƒ¨ç½²çš„è¿‡ç¨‹ã€‚</p><span id="more"></span><h2 id="é€‰å‹">é€‰å‹</h2><p>ç½‘ç«™çš„å»ºç«‹ä¸»è¦æ˜¯ä¸ºäº†æ­ä¸€ä¸ªåœ¨å…¬å¸å’Œå®¶é‡Œéƒ½èƒ½è®¿é—®çš„åšå®¢ç¯å¢ƒï¼Œå¯¹å·¥ä½œå’Œå­¦ä¹ åšä¸€äº›è®°å½•ï¼Œæ‰€ä»¥ç›´æ¥æ”¾å¼ƒä¼ ç»Ÿçš„å¸¦å‰ç«¯åç«¯çš„åŠ¨æ€é¡µé¢ï¼Œæ—¶é—´æˆæœ¬å¤ªé«˜ï¼Œæ•´ä¸€ä¸ªå¯ä»¥ä¸€é”®ä¸Šä¼  markdown çš„é™æ€é¡µé¢å°±æŒºokã€‚å‰ç«¯æ¡†æ¶é‡‡ç”¨ hexoï¼ŒUIé€‰æ‹© fluidï¼Œä»£ç æ”¾åœ¨ github ä¸Šï¼Œå¹¶ä½¿ç”¨ github action è¿›è¡ŒæŒç»­é›†æˆï¼Œéƒ¨ç½²åˆ° github pages åï¼Œåç»­å†™ä½œåªéœ€è¦ä¸€æ¬¡ git push å°±å¯ä»¥è‡ªåŠ¨å°†æ–‡ç« æ›´æ–°åˆ°ç›®æ ‡ç½‘ç«™ä¸Šã€‚</p><h2 id="æ¡†æ¶æ­å»º">æ¡†æ¶æ­å»º</h2><p><a href="https://hexo.io/zh-cn/docs/">https://hexo.io/zh-cn/docs/</a></p><h2 id="UIè®¾ç½®">UIè®¾ç½®</h2><p><a href="https://hexo.fluid-dev.com/docs/guide/">https://hexo.fluid-dev.com/docs/guide/</a></p><h2 id="éƒ¨ç½²">éƒ¨ç½²</h2><h3 id="å¿«é€Ÿéƒ¨ç½²">å¿«é€Ÿéƒ¨ç½²</h3><p><a href="https://hexo.io/zh-cn/docs/one-command-deployment">https://hexo.io/zh-cn/docs/one-command-deployment</a></p><p>é€‚ç”¨äºå¸Œæœ›æºä»£ç ä¿å­˜åœ¨æœ¬åœ°è€Œä¸ç”¨ä¸Šä¼ çš„æƒ…å†µï¼Œç›¸å½“äºæœ¬åœ°æ„å»ºå®Œå†å°†æ„å»ºå¥½çš„ç½‘é¡µç›´æ¥æ¨ç»™gh page</p><p>éœ€è¦åœ¨ _config.yml ä¸­é…ç½® gh page çš„ä»“åº“åœ°å€å’Œåˆ†æ”¯ï¼Œæ¨é€åï¼Œhexo ä¼šå°† public ç›®å½•ä¸­çš„æ–‡ä»¶æ¨é€è‡³_config.yml ä¸­æŒ‡å®šçš„åˆ†æ”¯ä¸­ï¼Œå¹¶ä¸”å®Œå…¨è¦†ç›–è¯¥åˆ†æ”¯ä¸‹çš„å·²æœ‰å†…å®¹ã€‚</p><p>è¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºæ˜¯åªä¼  public ç›®å½•ï¼ŒåŸŸåæ˜ å°„éœ€è¦çš„CNAMEæ–‡ä»¶åªèƒ½æ”¾åˆ° public ä¸‹ï¼Œè¿™æ ·æ¯æ¬¡ hexo clean åä¼šæ¸…ç©º publicï¼Œè¿˜å¾—å†ç¼–è¾‘ä¸€æ¬¡CNAMEï¼Œä½†æ˜¯å¥½å¤„åœ¨äºåˆ¨é™¤äº†äº‘ç«¯æ„å»ºçš„ä¸ç¨³å®šæ€§ï¼Œæ¯æ¬¡å¯ä»¥æœ¬åœ°çœ‹çœ‹ç½‘ç«™æ•ˆæœï¼Œå†ç›´æ¥æ”¾åˆ° gh page ä¸­</p><h3 id="gh-actions-æŒç»­é›†æˆ">gh actions æŒç»­é›†æˆ</h3><p><a href="https://easyhexo.com/1-Hexo-install-and-config/1-5-continuous-integration.html">https://easyhexo.com/1-Hexo-install-and-config/1-5-continuous-integration.html</a></p><p>æºä»£ç æ”¾åˆ° <a href="http://user.github.io">user.github.io</a> ä»“åº“ä¸­åï¼ˆä»“åº“ååªèƒ½è®¾ä¸ºè¿™ä¸ªï¼Œå¦åˆ™ç”Ÿæˆç½‘é¡µä¼šå˜æˆ <a href="http://user.github.io">user.github.io</a> çš„å­é¡µï¼‰ï¼ŒCNAME æ”¾åœ¨ source ä¸­ï¼Œç„¶ååœ¨ .github/workflws ä¸­å®šä¹‰ gh actions çš„è¯¦ç»†é…ç½®</p><p>é‡‡ç”¨çš„hexoå®˜æ–¹æ–‡æ¡£ä¸­çš„é…ç½®ï¼Œæœ€åä¸€æ­¥ä½¿ç”¨ peaceiris/actions-gh-pages@v3 å’±ä¹Ÿä¸å¤ªæ‡‚ï¼Œå‚è€ƒçŸ¥ä¹ä¸Šçš„å…¶ä»–é…ç½®ï¼Œå¤§æ¦‚ç›¸å½“äºå®‰è£… hexo å®Œäº†åœ¨å°† main åˆ†æ”¯çš„æºç  deploy åˆ° gh-pages åˆ†æ”¯ä¸Šï¼Œä¹‹ååœ¨è®¾ç½®æ—¶é€‰æ‹©è¿™ä¸ªåˆ†æ”¯å³å¯</p><p>ä¸»è¦é—®é¢˜åœ¨äºæ¯æ¬¡ push éƒ½è¦é‡æ–° buildï¼Œæ¨æµ‹åæœŸå†…å®¹å¢å¤šåç½‘ç«™æ›´æ–°ä¼šååˆ†ä¸åŠæ—¶ï¼Œå¯èƒ½éœ€è¦çœ‹çœ‹åˆ«äººçš„è¿½åŠ æ›´æ–°æ˜¯å’‹å¼„çš„</p><h3 id="CDNåŠ é€Ÿã€">CDNåŠ é€Ÿã€</h3><p>æ›´æ¢ Cloudflare çš„ DNSï¼Œæ³¨æ„ SSL/TLS åŠ å¯†æ¨¡å¼è®¾ä¸ºä¸¥æ ¼</p><h2 id="Summary">Summary</h2><p>å±äºæˆ‘çš„ç¬¬0ç¯‡åšå®¢ï¼Œå¤§æ¦‚ï¼Œèƒ½åœ¨ç½‘ç«™ä¸Šæ­£å¸¸æ˜¾ç¤ºï¼Œè¯æ˜åŸºæœ¬åŠŸèƒ½å·²ç»ok</p><h2 id="TODO">TODO</h2>]]></content>
    
    
    <categories>
      
      <category>work</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å‰ç«¯</tag>
      
      <tag>è®°å½•</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
